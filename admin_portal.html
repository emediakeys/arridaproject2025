<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Portal - School Management</title>

    <link rel="icon" type="image/png" sizes="32x32" href="icon.jpg">
    <link rel="icon" type="image/png" sizes="16x16" href="icon.jpg">
    <link rel="apple-touch-icon" href="icon.jpg">
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        /* Custom styles for better dashboard aesthetics */
        :root {
            --primary-color: #10b981; /* Emerald 500 */
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .nav-item {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            cursor: pointer;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
            transition: all 0.2s;
        }
        .nav-item:hover, .nav-item.active {
            background-color: var(--primary-color);
            color: white;
            box-shadow: 0 4px 6px -1px rgba(16, 185, 129, 0.3), 0 2px 4px -2px rgba(16, 185, 129, 0.3);
        }
        /* Style for the action buttons */
        .action-btn {
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            font-weight: 500;
        }
        /* Scrollable container for tables/lists */
        .data-container {
            max-height: 70vh;
            overflow-y: auto;
        }
        /* Hide scrollbar for clean look in comments but allow scroll */
        .custom-scrollbar::-webkit-scrollbar {
            width: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #e5e7eb;
            border-radius: 4px;
        }
        
        /* Mobile Sidebar Transitions */
        .sidebar {
            transition: transform 0.3s ease-in-out;
        }
        
        /* Smooth fade for elements */
        .fade-enter {
            opacity: 0;
            transform: translateY(10px);
            animation: fadeIn 0.3s forwards;
        }
        @keyframes fadeIn {
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body>

    <div id="app"></div>

    <div id="loadingOverlay" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl shadow-2xl max-w-sm w-full p-8 text-center transform transition-all scale-100">
            <div class="mx-auto w-16 h-16 bg-emerald-100 rounded-full flex items-center justify-center mb-4">
                <svg class="animate-spin h-8 w-8 text-emerald-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
            </div>
            <h3 class="text-lg font-bold text-gray-900">Please Wait</h3>
            <p class="mt-2 text-gray-500 font-medium" id="loadingText">Processing request...</p>
        </div>
    </div>

    <div id="messageModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl shadow-2xl max-w-sm w-full p-6">
            <h3 id="modalTitle" class="text-xl font-semibold text-gray-900 mb-2">Message</h3>
            <p id="modalMessage" class="text-gray-600 mb-6"></p>
            <button onclick="closeModal()" class="w-full py-2.5 bg-emerald-600 text-white font-medium rounded-lg hover:bg-emerald-700 transition shadow-md">
                Close
            </button>
        </div>
    </div>

    <div id="confirmModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl shadow-2xl max-w-sm w-full p-6 transform transition-all scale-100">
            <div class="mb-4">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-4">
                    <svg class="h-6 w-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                    </svg>
                </div>
                <h3 id="confirmTitle" class="text-lg leading-6 font-medium text-gray-900 text-center">Delete Item</h3>
                <div class="mt-2">
                    <p id="confirmMessage" class="text-sm text-gray-500 text-center">Are you sure you want to delete this? This action cannot be undone.</p>
                </div>
            </div>
            <div class="flex space-x-3">
                <button onclick="closeConfirm()" class="flex-1 py-2.5 px-4 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none transition">
                    Cancel
                </button>
                <button onclick="executeConfirm()" class="flex-1 py-2.5 px-4 bg-red-600 text-white rounded-lg text-sm font-medium hover:bg-red-700 focus:outline-none transition shadow-md">
                    Delete
                </button>
            </div>
        </div>
    </div>

    <div id="questionModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl p-6 max-h-[90vh] overflow-y-auto">
            <h3 class="text-xl font-bold text-gray-900 mb-4">Add Question</h3>
            <form id="addQuestionForm" class="space-y-4">
                <input type="hidden" id="q_examId">
                <textarea id="q_text" placeholder="Question Text" class="w-full p-3 border border-gray-300 rounded-lg bg-gray-50 focus:ring-emerald-500 focus:border-emerald-500" rows="3" required></textarea>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <input type="text" id="q_optA" placeholder="Option A" class="p-3 border border-gray-300 rounded-lg" required>
                    <input type="text" id="q_optB" placeholder="Option B" class="p-3 border border-gray-300 rounded-lg" required>
                    <input type="text" id="q_optC" placeholder="Option C" class="p-3 border border-gray-300 rounded-lg" required>
                    <input type="text" id="q_optD" placeholder="Option D" class="p-3 border border-gray-300 rounded-lg" required>
                </div>
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1">Correct Answer</label>
                    <select id="q_answer" class="w-full p-3 border border-gray-300 rounded-lg bg-gray-50" required>
                        <option value="">Select Correct Option</option>
                        <option value="A">Option A</option>
                        <option value="B">Option B</option>
                        <option value="C">Option C</option>
                        <option value="D">Option D</option>
                    </select>
                </div>
                <div class="flex space-x-3 pt-4">
                    <button type="button" onclick="document.getElementById('questionModal').classList.add('hidden'); document.getElementById('questionModal').classList.remove('flex');" class="flex-1 py-3 border border-gray-300 rounded-lg hover:bg-gray-50 text-gray-700 font-medium">Cancel</button>
                    <button type="submit" class="flex-1 py-3 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 font-medium shadow-md">Save Question</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // --- APP CONFIGURATION ---
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyMEpK3kKSrQR99hvVBA0fvs-_eWGKHzfQutXHy7X369_ELy0t8BpI-2mrSYnWKVkNX4Q/exec"; 
        
        // --- STATE MANAGEMENT ---
        let adminState = {
            isLoggedIn: false,
            username: '',
            assignedCourse: '',
            activeTab: 'dashboard', 
            students: [],
            announcements: [],
            assignments: [],
            attendance: [],
            exams: [], 
            isSidebarOpen: false 
        };

        let confirmCallback = null;

        // --- UI UTILITIES ---

        function setLoading(active, text = 'Processing...') {
            const overlay = document.getElementById('loadingOverlay');
            const txt = document.getElementById('loadingText');
            if (active) {
                txt.innerText = text;
                overlay.classList.remove('hidden');
                overlay.classList.add('flex');
            } else {
                overlay.classList.add('hidden');
                overlay.classList.remove('flex');
            }
        }

        function showModal(title, message, isError = false) {
            setLoading(false);
            const modal = document.getElementById('messageModal');
            const titleEl = document.getElementById('modalTitle');
            const msgEl = document.getElementById('modalMessage');

            titleEl.innerText = title;
            titleEl.className = isError ? "text-xl font-bold text-red-600 mb-2" : "text-xl font-bold text-emerald-600 mb-2";
            msgEl.innerText = message;

            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function closeModal() {
            const modal = document.getElementById('messageModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        function showConfirm(title, message, callback) {
            const modal = document.getElementById('confirmModal');
            document.getElementById('confirmTitle').innerText = title;
            document.getElementById('confirmMessage').innerText = message;
            
            confirmCallback = callback;
            
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function closeConfirm() {
            const modal = document.getElementById('confirmModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            confirmCallback = null;
        }

        function executeConfirm() {
            if (confirmCallback) {
                confirmCallback();
            }
            closeConfirm();
        }

        // --- CORE FUNCTIONS ---

        function render(component) {
            const app = document.getElementById('app');
            app.innerHTML = component();
            lucide.createIcons();
            if (adminState.isLoggedIn) {
                bindDashboardEvents();
            } else {
                bindLoginEvents();
            }
        }

        function jsonToUrlParams(data) {
            const params = new URLSearchParams();
            for (const key in data) {
                if (data.hasOwnProperty(key)) {
                    params.append(key, data[key]);
                }
            }
            return params;
        }

        async function fetchAppsScript(action, payload = {}, silent = false) {
            if(!silent && action !== 'toggleLike' && action !== 'addComment' && action !== 'adminLogin') {
                 setLoading(true, 'Loading data...'); 
            }

            const dataToSend = { action, ...payload };
            const formBody = jsonToUrlParams(dataToSend);
            
            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: formBody 
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const responseText = await response.text();
                const result = responseText ? JSON.parse(responseText) : {};
                
                if(!silent) setLoading(false);
                return result;

            } catch (error) {
                console.error('API Fetch Error:', error);
                if(!silent) setLoading(false);
                return { result: 'error', message: 'Network error. Check console.' };
            }
        }

        // --- AUTHENTICATION ---

        function checkAuth() {
            const storedState = localStorage.getItem('adminState');
            if (storedState) {
                const state = JSON.parse(storedState);
                if (state.isLoggedIn && state.assignedCourse) {
                    adminState = { ...adminState, ...state, isLoggedIn: true };
                    loadInitialData();
                    return;
                }
            }
            adminState.isLoggedIn = false;
            render(AdminLogin);
        }

        function saveAdminState() {
            localStorage.setItem('adminState', JSON.stringify({
                isLoggedIn: adminState.isLoggedIn,
                username: adminState.username,
                assignedCourse: adminState.assignedCourse
            }));
        }

        async function handleAdminLogin(e) {
            e.preventDefault();
            const form = e.target;
            const username = form.username.value.trim();
            const password = form.password.value;

            setLoading(true, 'Authenticating credentials...');

            const result = await fetchAppsScript('adminLogin', { username, password });

            if (result && result.result === 'success') {
                adminState.isLoggedIn = true;
                adminState.username = username;
                adminState.assignedCourse = result.assignedCourse;
                saveAdminState();
                
                setLoading(true, 'Login successful! Setting up dashboard...');
                setTimeout(() => {
                    setLoading(false);
                    loadInitialData();
                }, 800); 
            } else {
                setLoading(false);
                const errMsg = result ? result.message : 'Unknown login error';
                showModal('Login Failed', errMsg, true);
            }
        }

        function handleLogout() {
            localStorage.removeItem('adminState');
            adminState = { 
                isLoggedIn: false, 
                username: '', 
                assignedCourse: '', 
                activeTab: 'dashboard', 
                students: [], announcements: [], assignments: [], attendance: [],
                exams: [],
                isSidebarOpen: false
            };
            render(AdminLogin);
        }

        function bindLoginEvents() {
            const loginForm = document.getElementById('adminLoginForm');
            if (loginForm) {
                loginForm.addEventListener('submit', handleAdminLogin);
            }
        }

        // --- DATA LOADING & DASHBOARD MANAGEMENT ---

        async function loadInitialData(silent = false) {
            if (!adminState.isLoggedIn) return;
            
            if(!document.getElementById('sidebar')) {
                render(AdminDashboard);
            }

            if(!silent && adminState.students.length === 0) {
                setLoading(true, 'Fetching dashboard data...');
            }

            const course = adminState.assignedCourse;

            try {
                const [studentsResult, announcementsResult, assignmentsResult, examsResult] = await Promise.all([
                    fetchAppsScript('getStudentsByCourse', { course }, true),
                    fetchAppsScript('getAnnouncementsByCourse', { course, currentUser: adminState.username }, true),
                    fetchAppsScript('getAssignmentsByCourse', { course }, true),
                    fetchAppsScript('getExamsAdmin', { course }, true)
                ]);

                if(studentsResult.result === 'success') adminState.students = studentsResult.data;
                if(announcementsResult.result === 'success') adminState.announcements = announcementsResult.data;
                if(assignmentsResult.result === 'success') adminState.assignments = assignmentsResult.data;
                if(examsResult.result === 'success') adminState.exams = examsResult.data;

            } catch (err) {
                console.error("Error loading dashboard data", err);
            }
            
            setLoading(false);
            render(AdminDashboard);
        }

        function changeTab(tabName) {
            adminState.activeTab = tabName;
            if(window.innerWidth < 768) {
                adminState.isSidebarOpen = false;
            }
            render(AdminDashboard);
        }

        function toggleSidebar() {
            adminState.isSidebarOpen = !adminState.isSidebarOpen;
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            
            if (adminState.isSidebarOpen) {
                sidebar.classList.remove('-translate-x-full');
                sidebar.classList.add('translate-x-0');
                overlay.classList.remove('hidden');
            } else {
                sidebar.classList.add('-translate-x-full');
                sidebar.classList.remove('translate-x-0');
                overlay.classList.add('hidden');
            }
        }

        // --- EXAM LOGIC ---
        
        async function handleCreateExam(e) {
            e.preventDefault();
            const title = e.target.title.value;
            const duration = e.target.duration.value;
            
            const result = await fetchAppsScript('createExam', { course: adminState.assignedCourse, title, duration });
            
            if(result.result === 'success') { 
                showModal('Success', 'Exam created successfully!'); 
                loadInitialData(); 
            } else { 
                showModal('Error', result.message, true); 
            }
        }

        function openAddQuestionModal(examId) {
            document.getElementById('q_examId').value = examId;
            document.getElementById('addQuestionForm').reset();
            document.getElementById('questionModal').classList.remove('hidden');
            document.getElementById('questionModal').classList.add('flex');
        }

        async function handleAddQuestion(e) {
            e.preventDefault();
            const val = (id) => document.getElementById(id).value;
            
            const ansKey = val('q_answer');
            if(!ansKey) { showModal('Error', 'Please select correct answer', true); return; }
            const ansText = val('q_opt' + ansKey); 
            
            const data = {
                examId: val('q_examId'),
                question: val('q_text'),
                optA: val('q_optA'),
                optB: val('q_optB'),
                optC: val('q_optC'),
                optD: val('q_optD'),
                answer: ansText
            };
            
            const res = await fetchAppsScript('addQuestion', data);
            if(res.result === 'success') { 
                showModal('Success', 'Question added successfully!'); 
                e.target.reset(); 
            } else { 
                showModal('Error', 'Failed to add question.', true); 
            }
        }

        async function toggleExamStatus(examId) {
            const res = await fetchAppsScript('toggleExamStatus', { examId });
            if(res.result === 'success') loadInitialData();
        }
        
        async function toggleResultRelease(examId) {
            const res = await fetchAppsScript('toggleResultRelease', { examId });
            if(res.result === 'success') loadInitialData();
        }

        async function deleteExam(examId) {
            showConfirm("Delete Exam?", "Are you sure? This cannot be undone.", async () => {
                 setLoading(true, "Deleting Exam...");
                 const res = await fetchAppsScript('deleteExam', { examId });
                 if(res.result === 'success') loadInitialData();
            });
        }

        // --- CRUD OPERATIONS (STANDARD) ---

        async function handleAddAnnouncement(e) {
            e.preventDefault();
            const form = e.target;
            const title = form.title.value;
            const content = form.content.value;
            const visibility = form.visibility.value; 
            const course = adminState.assignedCourse;
            
            const result = await fetchAppsScript('addAnnouncement', { course, title, content, visibility });

            if (result.result === 'success') {
                showModal('Success', 'Announcement posted successfully!');
                form.reset();
                loadInitialData(); 
            } else {
                showModal('Error', result.message || 'Failed to post.', true);
            }
        }

        function handleDeleteAnnouncement(id) {
            showConfirm("Delete Post?", "Are you sure you want to delete this announcement? This cannot be undone.", async () => {
                setLoading(true, "Deleting Post...");
                const result = await fetchAppsScript('deleteAnnouncement', { id });
                if (result.result === 'success') {
                    showModal('Deleted', 'Post deleted successfully.');
                    loadInitialData();
                } else {
                    showModal('Error', result.message || 'Failed to delete.', true);
                }
            });
        }

        // --- IMPROVED UI/UX: LIKES & COMMENTS ---
        
        function toggleComments(annId) {
            const section = document.getElementById(`comments-section-${annId}`);
            const chevron = document.getElementById(`chevron-${annId}`);
            
            if(section.classList.contains('hidden')) {
                section.classList.remove('hidden');
                chevron.style.transform = 'rotate(180deg)';
                // Optional: Scroll slightly to show more if needed, but standard toggle is usually fine
            } else {
                section.classList.add('hidden');
                chevron.style.transform = 'rotate(0deg)';
            }
        }

        async function handleLikeOptimistic(btn, annId) {
            const icon = btn.querySelector('[data-lucide="heart"]');
            const countSpan = btn.querySelector('span:nth-child(2)');
            let count = parseInt(countSpan.innerText) || 0;
            
            // Check current state based on visual class
            const isLiked = icon.classList.contains('text-red-500');
            
            // Optimistic Update
            if (isLiked) {
                // Unlike
                icon.classList.remove('fill-current', 'text-red-500');
                icon.classList.add('text-gray-500');
                countSpan.classList.remove('text-red-500', 'font-bold');
                countSpan.innerText = Math.max(0, count - 1);
            } else {
                // Like
                icon.classList.remove('text-gray-500');
                icon.classList.add('fill-current', 'text-red-500');
                countSpan.classList.add('text-red-500', 'font-bold');
                countSpan.innerText = count + 1;
            }

            // Send to backend silently - DO NOT refresh data to keep UI stable
            await fetchAppsScript('toggleLike', { announcementId: annId, user: adminState.username }, true);
        }

        async function handlePostCommentOptimistic(e, annId) {
            e.preventDefault();
            const input = e.target.comment;
            const text = input.value.trim();
            if(!text) return;
            
            const list = document.getElementById(`comments-list-${annId}`);
            
            // Remove "No comments" placeholder if present
            if(list.querySelector('p.italic')) {
                list.innerHTML = '';
            }
            
            // Optimistically append new comment
            const newCommentHtml = `
                <div class="animate-pulse fade-enter">
                    <div class="flex items-start space-x-2">
                        <div class="w-6 h-6 rounded-full bg-emerald-100 flex items-center justify-center text-[10px] font-bold text-emerald-700">ME</div>
                        <div class="flex-1 bg-white p-2 rounded-lg rounded-tl-none shadow-sm border border-gray-100">
                            <p class="font-bold text-gray-800 text-[11px] mb-0.5">${adminState.username} <span class="text-[9px] text-gray-400 font-normal">‚Ä¢ Just now</span></p>
                            <p class="text-gray-600 leading-relaxed">${text}</p>
                        </div>
                    </div>
                </div>
            `;
            
            // Append
            const temp = document.createElement('div');
            temp.innerHTML = newCommentHtml;
            const newCommentEl = temp.firstElementChild;
            list.appendChild(newCommentEl);
            list.scrollTop = list.scrollHeight;
            
            input.value = ''; // Clear input immediately
            
            // Update the comment count in the button text
            // We search for the specific button associated with this announcement
            const commentBtn = document.querySelector(`button[onclick="toggleComments('${annId}')"] span:nth-child(2)`);
            if(commentBtn) {
                let currentCount = parseInt(commentBtn.innerText) || 0;
                commentBtn.innerText = `${currentCount + 1} Comments`;
            }

            // Send to backend silently
            await fetchAppsScript('addComment', { announcementId: annId, user: adminState.username, comment: text }, true);
            
            // Remove pulse animation after a moment
            setTimeout(() => {
                newCommentEl.classList.remove('animate-pulse');
            }, 1000);
        }

        async function handleAddAssignment(e) {
            e.preventDefault();
            const form = e.target;
            const title = form.title.value;
            const description = form.description.value;
            const dueDate = form.dueDate.value;
            const course = adminState.assignedCourse;

            const result = await fetchAppsScript('addAssignment', { course, title, description, dueDate });

            if (result.result === 'success') {
                showModal('Success', 'Assignment added successfully!');
                form.reset();
                loadInitialData(); 
            } else {
                showModal('Error', result.message || 'Failed.', true);
            }
        }

        function handleDeleteAssignment(id) {
            showConfirm("Delete Assignment?", "Are you sure you want to remove this assignment? Students will no longer see it.", async () => {
                setLoading(true, "Deleting Assignment...");
                const result = await fetchAppsScript('deleteAssignment', { id });
                if (result.result === 'success') {
                    showModal('Deleted', 'Assignment deleted successfully.');
                    loadInitialData();
                } else {
                    showModal('Error', result.message || 'Failed to delete.', true);
                }
            });
        }

        async function handleRemoveStudent(admNo, course) {
            showConfirm("Remove Student?", `Are you sure you want to remove ${admNo}? This will delete their record from the class list.`, async () => {
                setLoading(true, `Removing ${admNo}...`);
                const result = await fetchAppsScript('removeStudent', { admNo, course });
                if (result.result === 'success') {
                    showModal('Removed', `Student ${admNo} has been removed.`);
                    adminState.students = adminState.students.filter(s => s.admNo !== admNo);
                    render(AdminDashboard); 
                } else {
                    showModal('Error', result.message || 'Failed.', true);
                }
            });
        }

        // --- ATTENDANCE LOGIC ---

        function filterAttendanceList(query) {
            const listContainer = document.getElementById('attendanceListContainer');
            const lowerQuery = query.toLowerCase();
            
            const filteredStudents = adminState.students.filter(s => 
                s.firstName.toLowerCase().includes(lowerQuery) || 
                s.lastName.toLowerCase().includes(lowerQuery) || 
                String(s.admNo).toLowerCase().includes(lowerQuery)
            );

            if (filteredStudents.length === 0) {
                listContainer.innerHTML = `<div class="p-8 text-center text-gray-500">No students found matching "${query}"</div>`;
                return;
            }

            listContainer.innerHTML = filteredStudents.map(student => `
                <div class="flex items-center justify-between p-4 border-b border-gray-100 hover:bg-gray-50 transition">
                    <div class="flex items-center space-x-4">
                        <div class="bg-indigo-100 text-indigo-700 w-10 h-10 rounded-full flex items-center justify-center font-bold text-xs">
                            ${student.admNo}
                        </div>
                        <div>
                            <p class="font-semibold text-gray-800">${student.firstName} ${student.lastName}</p>
                            <p class="text-xs text-gray-500">${student.email}</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-2">
                        <select id="status-${student.admNo}" class="text-sm border-gray-300 rounded-md shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 p-2 border">
                            <option value="Present">Present</option>
                            <option value="Absent">Absent</option>
                            <option value="Late">Late</option>
                            <option value="Excused">Excused</option>
                        </select>
                        <button onclick="handleQuickAttendance('${student.admNo}')" 
                                class="bg-indigo-600 hover:bg-indigo-700 text-white p-2 rounded-md shadow transition flex items-center">
                            <span data-lucide="check" class="w-4 h-4"></span>
                            <span class="ml-2 text-xs font-bold uppercase hidden md:inline">Save</span>
                        </button>
                    </div>
                </div>
            `).join('');
            
            lucide.createIcons(); 
        }

        async function handleQuickAttendance(admNo) {
            const date = document.getElementById('attendanceDate').value;
            const statusSelect = document.getElementById(`status-${admNo}`);
            const status = statusSelect.value;
            const course = adminState.assignedCourse;

            const btn = statusSelect.nextElementSibling;
            const originalContent = btn.innerHTML;
            btn.innerHTML = `<span class="animate-spin w-4 h-4 border-2 border-white border-t-transparent rounded-full"></span>`;
            btn.disabled = true;

            try {
                const formBody = new URLSearchParams({
                    action: 'recordAttendance', admNo, status, date, course
                });
                const response = await fetch(SCRIPT_URL, { method: 'POST', body: formBody });
                const result = await response.json();

                if (result.result === 'success') {
                    btn.innerHTML = `<span data-lucide="check-circle" class="w-4 h-4"></span>`;
                    btn.classList.replace('bg-indigo-600', 'bg-green-500');
                    btn.classList.replace('hover:bg-indigo-700', 'hover:bg-green-600');
                    
                    const toast = document.getElementById('toastMsg');
                    toast.innerText = `Recorded: ${admNo} is ${status}`;
                    toast.classList.remove('opacity-0', 'translate-y-4');
                    setTimeout(() => {
                        toast.classList.add('opacity-0', 'translate-y-4');
                        btn.innerHTML = originalContent;
                        btn.classList.replace('bg-green-500', 'bg-indigo-600');
                        btn.classList.replace('hover:bg-green-600', 'hover:bg-indigo-700');
                        btn.disabled = false;
                        lucide.createIcons();
                    }, 2000);
                } else {
                    showModal("Error", result.message, true);
                    btn.innerHTML = originalContent;
                    btn.disabled = false;
                    lucide.createIcons();
                }
            } catch(e) {
                showModal("Error", "Network connection failed.", true);
                btn.innerHTML = originalContent;
                btn.disabled = false;
                lucide.createIcons();
            }
        }


        // --- UI COMPONENTS ---

        function AdminLogin() {
            return `
                <div class="min-h-screen flex items-center justify-center p-4">
                    <div class="w-full max-w-md bg-white p-8 rounded-xl shadow-2xl border border-gray-100">
                        <div class="text-center mb-8">
                            <h2 class="text-3xl font-extrabold text-gray-900">Admin Login</h2>
                            <p class="mt-2 text-sm text-gray-600">School Management System</p>
                        </div>
                        <form id="adminLoginForm" class="space-y-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Username</label>
                                <input type="text" name="username" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                                <input type="password" name="password" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500">
                            </div>
                            <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-emerald-600 hover:bg-emerald-700 transition">
                                <span data-lucide="log-in" class="w-5 h-5 mr-2"></span> Log In
                            </button>
                        </form>
                    </div>
                </div>
            `;
        }

        function AdminDashboard() {
            const tabs = [
                { id: 'dashboard', name: 'Dashboard', icon: 'layout-dashboard' },
                { id: 'students', name: 'Students', icon: 'users' },
                { id: 'announcements', name: 'News', icon: 'megaphone' },
                { id: 'assignments', name: 'Assignments', icon: 'clipboard-list' },
                { id: 'exams', name: 'CBT / Exams', icon: 'monitor-check' },
                { id: 'attendance', name: 'Attendance', icon: 'calendar-check' },
            ];

            const sidebarClasses = adminState.isSidebarOpen ? 'translate-x-0' : '-translate-x-full';
            const overlayClasses = adminState.isSidebarOpen ? '' : 'hidden';

            return `
                <div class="min-h-screen flex relative overflow-hidden bg-gray-50">
                    
                    <div id="sidebarOverlay" onclick="toggleSidebar()" 
                        class="fixed inset-0 bg-black bg-opacity-50 z-40 transition-opacity duration-300 md:hidden ${overlayClasses}">
                    </div>

                    <div id="sidebar" class="sidebar fixed inset-y-0 left-0 z-50 w-64 bg-gray-800 text-white flex flex-col shadow-2xl transform transition-transform duration-300 ease-in-out md:translate-x-0 md:static md:inset-auto ${sidebarClasses}">
                        
                        <div class="flex-shrink-0 flex items-center justify-between p-4 border-b border-gray-700">
                            <div class="flex items-center font-bold text-lg">
                                <span data-lucide="graduation-cap" class="w-6 h-6 mr-2 text-emerald-400"></span>
                                <span>Admin Panel</span>
                            </div>
                            <button onclick="toggleSidebar()" class="md:hidden text-gray-400 hover:text-white cursor-pointer">
                                <span data-lucide="x" class="w-6 h-6"></span>
                            </button>
                        </div>
                        
                        <div class="p-4 border-b border-gray-700 bg-gray-900/30">
                            <p class="font-semibold text-sm truncate">${adminState.username}</p>
                            <p class="text-xs text-gray-400 mt-1 truncate">Course: ${adminState.assignedCourse}</p>
                        </div>

                        <nav class="flex-grow p-4 space-y-1 overflow-y-auto">
                            ${tabs.map(tab => `
                                <div class="nav-item ${adminState.activeTab === tab.id ? 'active' : 'text-gray-300 hover:bg-gray-700 hover:text-white'}" 
                                     data-tab="${tab.id}">
                                    <span data-lucide="${tab.icon}" class="w-5 h-5 mr-3"></span>
                                    ${tab.name}
                                </div>
                            `).join('')}
                        </nav>

                        <div class="p-4 border-t border-gray-700">
                            <button id="logoutBtn" class="w-full flex items-center justify-center p-3 text-red-400 hover:bg-gray-700 rounded-lg transition duration-150 group">
                                <span data-lucide="log-out" class="w-5 h-5 mr-2 group-hover:text-red-300"></span> Logout
                            </button>
                        </div>
                    </div>

                    <main class="flex-grow flex flex-col h-screen overflow-hidden relative">
                        
                        <div class="md:hidden bg-white shadow-sm border-b border-gray-200 p-4 flex items-center justify-between flex-shrink-0 z-30">
                            <div class="flex items-center">
                                <button onclick="toggleSidebar()" class="mr-3 text-gray-600 hover:text-emerald-600 focus:outline-none cursor-pointer">
                                    <span data-lucide="menu" class="w-6 h-6"></span>
                                </button>
                                <h1 class="text-lg font-bold text-gray-800">
                                    ${tabs.find(t => t.id === adminState.activeTab).name}
                                </h1>
                            </div>
                            <div class="w-8 h-8 bg-emerald-100 rounded-full flex items-center justify-center text-emerald-600 font-bold text-xs">
                                AD
                            </div>
                        </div>

                        <div class="flex-grow overflow-y-auto p-4 md:p-8">
                            <h1 class="text-3xl font-bold text-gray-800 mb-6 hidden md:block">
                                ${tabs.find(t => t.id === adminState.activeTab).name} Management
                            </h1>

                            <div id="toastMsg" class="fixed bottom-4 right-4 bg-gray-800 text-white px-6 py-3 rounded-lg shadow-lg transform transition-all duration-300 opacity-0 translate-y-4 z-50 flex items-center">
                                <span data-lucide="info" class="w-4 h-4 mr-2"></span>
                                <span>Notification</span>
                            </div>

                            <div class="min-h-[500px]">
                                ${renderActiveTabContent()}
                            </div>
                        </div>
                    </main>
                </div>
            `;
        }

        function renderActiveTabContent() {
            switch (adminState.activeTab) {
                case 'dashboard': return DashboardTab();
                case 'students': return StudentList();
                case 'announcements': return AnnouncementsTab();
                case 'assignments': return AssignmentsTab();
                case 'exams': return renderExamsTab();
                case 'attendance': return AttendanceTab();
                default: return `<p>Select a tab.</p>`;
            }
        }

        // --- TAB CONTENTS ---

        function DashboardTab() {
            const studentCount = adminState.students.length;
            const assignmentCount = adminState.assignments.length;
            const announcementCount = adminState.announcements.length;
            const examCount = adminState.exams.length;

            return `
                <h2 class="text-2xl font-semibold mb-6 text-gray-700 hidden md:block">Course: ${adminState.assignedCourse}</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-blue-500 flex justify-between items-center">
                        <div><p class="text-sm font-medium text-gray-500">Total Students</p><p class="text-3xl font-extrabold text-gray-800 mt-1">${studentCount}</p></div>
                        <div class="p-3 bg-blue-50 rounded-lg text-blue-500"><span data-lucide="users" class="w-6 h-6"></span></div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-yellow-500 flex justify-between items-center">
                        <div><p class="text-sm font-medium text-gray-500">Active Assignments</p><p class="text-3xl font-extrabold text-gray-800 mt-1">${assignmentCount}</p></div>
                        <div class="p-3 bg-yellow-50 rounded-lg text-yellow-500"><span data-lucide="clipboard-list" class="w-6 h-6"></span></div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-emerald-500 flex justify-between items-center">
                        <div><p class="text-sm font-medium text-gray-500">Total Announcements</p><p class="text-3xl font-extrabold text-gray-800 mt-1">${announcementCount}</p></div>
                        <div class="p-3 bg-emerald-50 rounded-lg text-emerald-500"><span data-lucide="megaphone" class="w-6 h-6"></span></div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-purple-500 flex justify-between items-center">
                        <div><p class="text-sm font-medium text-gray-500">Total Exams</p><p class="text-3xl font-extrabold text-gray-800 mt-1">${examCount}</p></div>
                        <div class="p-3 bg-purple-50 rounded-lg text-purple-500"><span data-lucide="monitor-check" class="w-6 h-6"></span></div>
                    </div>
                </div>
            `;
        }

        function StudentList() {
            return `
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                    <div class="p-4 border-b border-gray-200 flex justify-between items-center bg-gray-50">
                        <h2 class="text-lg font-bold text-gray-800">Student Directory</h2>
                        <span class="bg-gray-200 text-gray-700 text-xs px-2 py-1 rounded-full font-bold">${adminState.students.length}</span>
                    </div>
                    ${adminState.students.length === 0 ? `<p class="p-8 text-center text-gray-500">No students found.</p>` : `
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Adm. No</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Action</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    ${adminState.students.map(s => `
                                        <tr>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${s.admNo}</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${s.firstName} ${s.lastName}</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm">
                                                <button onclick="handleRemoveStudent('${s.admNo}', '${adminState.assignedCourse}')" class="text-red-600 hover:text-red-900 bg-red-50 px-3 py-1 rounded-md font-medium text-xs transition">Remove</button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>`}
                </div>
            `;
        }

        function AnnouncementsTab() {
            return `
                <div class="max-w-5xl mx-auto">
                    <div class="flex flex-col lg:flex-row gap-6">
                        <div class="lg:w-1/3 order-1">
                            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4 lg:sticky lg:top-4">
                                <h2 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                                    <span data-lucide="pen-tool" class="w-5 h-5 mr-2 text-emerald-600"></span>
                                    Create Post
                                </h2>
                                <form id="announcementForm" class="space-y-4">
                                    <div>
                                        <input type="text" name="title" required placeholder="Post Title" 
                                            class="w-full px-4 py-2 bg-gray-50 border border-gray-200 rounded-lg focus:bg-white focus:ring-2 focus:ring-emerald-500 focus:border-transparent transition-all outline-none text-sm font-semibold text-gray-800">
                                    </div>
                                    <div>
                                        <textarea name="content" rows="4" required placeholder="What's happening in ${adminState.assignedCourse}?" 
                                            class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-lg focus:bg-white focus:ring-2 focus:ring-emerald-500 focus:border-transparent transition-all outline-none text-sm resize-none"></textarea>
                                    </div>
                                    <div>
                                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Visibility</label>
                                        <select name="visibility" class="w-full px-4 py-2 bg-gray-50 border border-gray-200 rounded-lg focus:bg-white focus:ring-2 focus:ring-emerald-500 focus:border-transparent transition-all outline-none text-sm text-gray-800">
                                            <option value="public" selected>üåç Public (Home Page & Students)</option>
                                            <option value="private">üîí Private (Course Students Only)</option>
                                        </select>
                                    </div>
                                    <button type="submit" class="w-full py-2.5 bg-emerald-600 hover:bg-emerald-700 text-white font-medium rounded-lg shadow-md hover:shadow-lg transition-all duration-200 flex items-center justify-center transform active:scale-95">
                                        <span data-lucide="send" class="w-4 h-4 mr-2"></span> Post Update
                                    </button>
                                </form>
                            </div>
                        </div>

                        <div class="lg:w-2/3 order-2">
                            <div class="flex items-center justify-between mb-4 px-1">
                                <h2 class="text-xl font-bold text-gray-800">News Feed</h2>
                                <span class="text-xs font-medium text-gray-500 bg-white px-2 py-1 rounded-full border shadow-sm">
                                    ${adminState.announcements.length} Posts
                                </span>
                            </div>
                            <div class="space-y-5 pb-20">
                                ${adminState.announcements.length === 0 ? 
                                    `<div class="bg-white rounded-xl shadow-sm border border-gray-200 p-8 text-center"><div class="mx-auto w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mb-4"><span data-lucide="coffee" class="w-8 h-8 text-gray-400"></span></div><h3 class="text-lg font-medium text-gray-900">No posts yet</h3><p class="text-gray-500 mt-1">Be the first to post an update for your students.</p></div>` : 
                                    adminState.announcements.map((a, index) => {
                                        const likes = a.likes || 0;
                                        const comments = a.comments || [];
                                        const likedByMe = a.likedByMe || false;
                                        const annId = a.id;
                                        const initials = "AD"; 
                                        const isPublic = a.visibility === 'public';
                                        
                                        const likeColorClass = likedByMe ? 'fill-current text-red-500' : 'text-gray-500';
                                        const likeCountClass = likedByMe ? 'text-red-500 font-bold' : 'text-gray-500';
                                        
                                        return `
                                        <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden transition-shadow hover:shadow-md">
                                            <div class="p-4 flex items-center space-x-3">
                                                <div class="w-10 h-10 rounded-full bg-gradient-to-br from-emerald-500 to-teal-600 flex items-center justify-center text-white font-bold text-sm shadow-sm">${initials}</div>
                                                <div class="flex-1 min-w-0">
                                                    <p class="text-sm font-bold text-gray-900 truncate">${adminState.username || 'Administrator'} ${isPublic ? '<span class="ml-2 text-[10px] bg-blue-100 text-blue-600 px-1.5 py-0.5 rounded-full uppercase tracking-wider">Public</span>' : '<span class="ml-2 text-[10px] bg-gray-100 text-gray-600 px-1.5 py-0.5 rounded-full uppercase tracking-wider">Private</span>'}</p>
                                                    <p class="text-xs text-gray-500 flex items-center"><span>${a.date}</span><span class="mx-1">‚Ä¢</span><span class="text-emerald-600 font-medium bg-emerald-50 px-1.5 rounded text-[10px]">Admin</span></p>
                                                </div>
                                                <button onclick="handleDeleteAnnouncement('${annId}')" class="text-gray-400 hover:text-red-500 transition"><span data-lucide="trash-2" class="w-5 h-5"></span></button>
                                            </div>
                                            <div class="px-4 pb-2"><h3 class="text-base font-bold text-gray-900 mb-2 leading-tight">${a.title}</h3><div class="text-sm text-gray-700 leading-relaxed whitespace-pre-wrap">${a.content}</div></div>
                                            
                                            <div class="px-4 py-2 flex items-center justify-between border-t border-gray-100 text-xs text-gray-500 bg-gray-50">
                                                 <button onclick="handleLikeOptimistic(this, '${annId}')" class="flex items-center space-x-1 hover:bg-gray-200 p-2 rounded-lg transition group cursor-pointer">
                                                    <span data-lucide="heart" class="w-4 h-4 transition-transform group-active:scale-125 ${likeColorClass}"></span> 
                                                    <span class="${likeCountClass}">${likes}</span>
                                                 </button>
                                                 
                                                 <button onclick="toggleComments('${annId}')" class="flex items-center space-x-1 hover:bg-gray-200 p-2 rounded-lg transition text-gray-600 cursor-pointer">
                                                    <span data-lucide="message-circle" class="w-4 h-4"></span>
                                                    <span>${comments.length} Comments</span>
                                                    <span id="chevron-${annId}" data-lucide="chevron-down" class="w-3 h-3 transition-transform duration-300"></span>
                                                 </button>
                                            </div>
                                            
                                            <div id="comments-section-${annId}" class="hidden bg-gray-50 border-t border-gray-100">
                                                 <div id="comments-list-${annId}" class="p-4 max-h-60 overflow-y-auto text-xs space-y-3 custom-scrollbar">
                                                      ${comments.map(c => `
                                                        <div class="flex items-start space-x-2">
                                                            <div class="w-6 h-6 rounded-full bg-gray-200 flex items-center justify-center text-[10px] font-bold text-gray-600">${c.user.substring(0,2).toUpperCase()}</div>
                                                            <div class="flex-1 bg-white p-2 rounded-lg rounded-tl-none shadow-sm border border-gray-100">
                                                                <p class="font-bold text-gray-800 text-[11px] mb-0.5">${c.user} <span class="text-[9px] text-gray-400 font-normal">‚Ä¢ ${c.time || ''}</span></p>
                                                                <p class="text-gray-600 leading-relaxed">${c.text}</p>
                                                            </div>
                                                        </div>
                                                      `).join('') || '<p class="text-gray-400 italic text-center py-2">No comments yet. Be the first to start the conversation.</p>'}
                                                 </div>
                                                 <form onsubmit="handlePostCommentOptimistic(event, '${annId}')" class="p-3 border-t border-gray-200 flex gap-2 bg-white">
                                                    <input type="text" name="comment" placeholder="Write a comment..." class="flex-1 bg-gray-100 border-transparent focus:bg-white focus:border-emerald-500 focus:ring-0 rounded-lg px-3 py-2 text-xs transition outline-none">
                                                    <button type="submit" class="text-xs bg-emerald-600 text-white px-4 py-2 rounded-lg hover:bg-emerald-700 font-medium transition shadow-sm">Post</button>
                                                 </form>
                                            </div>
                                        </div>`;
                                    }).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function AssignmentsTab() {
            return `
                <div class="grid md:grid-cols-2 gap-8">
                    <div>
                        <h2 class="text-2xl font-semibold mb-4 text-gray-700">New Assignment</h2>
                        <form id="assignmentForm" class="space-y-4 bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                            <input type="text" name="title" required placeholder="Title" class="w-full px-3 py-2 border rounded-lg bg-gray-50 focus:bg-white transition">
                            <textarea name="description" rows="4" required placeholder="Details" class="w-full px-3 py-2 border rounded-lg bg-gray-50 focus:bg-white transition"></textarea>
                            <input type="date" name="dueDate" required class="w-full px-3 py-2 border rounded-lg bg-gray-50 focus:bg-white transition">
                            <button type="submit" class="action-btn bg-blue-600 text-white w-full hover:bg-blue-700 transition shadow-md">Create</button>
                        </form>
                    </div>
                    <div>
                        <h2 class="text-2xl font-semibold mb-4 text-gray-700">Active</h2>
                        <div class="space-y-4 data-container max-h-96 overflow-y-auto">
                             ${adminState.assignments.map(a => `
                                <div class="p-4 border rounded-lg bg-white shadow-sm border-l-4 border-blue-500 relative group">
                                    <button onclick="handleDeleteAssignment('${a.id}')" class="absolute top-2 right-2 text-gray-400 hover:text-red-500 opacity-0 group-hover:opacity-100 transition">
                                        <span data-lucide="trash-2" class="w-4 h-4"></span>
                                    </button>
                                    <p class="font-bold text-gray-900 pr-6">${a.title}</p>
                                    <p class="text-sm text-gray-600 mt-1">${a.description}</p>
                                    <p class="text-xs mt-2 font-medium text-blue-600 bg-blue-50 inline-block px-2 py-1 rounded">Due: ${a.dueDate}</p>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        // --- NEW: EXAM MANAGEMENT TAB ---
        function renderExamsTab() {
            return `
                <div class="grid md:grid-cols-2 gap-8">
                    <div>
                        <h2 class="text-2xl font-bold mb-4 text-gray-800">Create Exam</h2>
                        <form onsubmit="handleCreateExam(event)" class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 space-y-4">
                            <input name="title" placeholder="Exam Title (e.g. 1st Semester GST)" class="w-full px-3 py-2 border rounded-lg bg-gray-50 focus:bg-white" required>
                            <input name="duration" type="number" placeholder="Duration (Minutes)" class="w-full px-3 py-2 border rounded-lg bg-gray-50 focus:bg-white" required>
                            <button class="w-full py-2.5 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg shadow-md transition">Create Exam</button>
                        </form>
                    </div>
                    <div>
                        <h2 class="text-2xl font-bold mb-4 text-gray-800">Manage Exams</h2>
                        <div class="space-y-4 data-container max-h-96 overflow-y-auto">
                            ${adminState.exams.length === 0 ? '<div class="p-8 text-center text-gray-500 bg-white rounded-xl border border-gray-200">No exams created yet.</div>' : adminState.exams.map(ex => `
                                <div class="bg-white p-5 rounded-xl shadow-sm border border-l-4 ${ex.status==='Open'?'border-green-500':'border-gray-400'}">
                                    <div class="flex justify-between items-start mb-2">
                                        <div>
                                            <h3 class="font-bold text-lg text-gray-900">${ex.title}</h3>
                                            <p class="text-xs text-gray-500">${ex.duration} Mins ‚Ä¢ <span class="${ex.status==='Open'?'text-green-600':'text-red-500'} font-bold">${ex.status}</span></p>
                                        </div>
                                        <button onclick="deleteExam('${ex.id}')" class="text-gray-400 hover:text-red-500 transition"><span data-lucide="trash-2" class="w-4 h-4"></span></button>
                                    </div>
                                    
                                    <div class="flex gap-2 mt-3 mb-3">
                                        <button onclick="toggleExamStatus('${ex.id}')" class="flex-1 py-1.5 text-xs font-bold border rounded transition ${ex.status==='Open'?'bg-red-50 text-red-600 border-red-200 hover:bg-red-100':'bg-green-50 text-green-600 border-green-200 hover:bg-green-100'}">
                                            ${ex.status==='Open'?'Close Exam':'Open Exam'}
                                        </button>
                                        <button onclick="toggleResultRelease('${ex.id}')" class="flex-1 py-1.5 text-xs font-bold border rounded transition ${ex.resultStatus==='Released'?'bg-blue-50 text-blue-600 border-blue-200 hover:bg-blue-100':'bg-gray-100 text-gray-600 border-gray-200 hover:bg-gray-200'}">
                                            ${ex.resultStatus==='Released'?'Results: Released':'Results: Held'}
                                        </button>
                                    </div>

                                    <button onclick="openAddQuestionModal('${ex.id}')" class="w-full py-2 border border-dashed border-blue-300 text-blue-600 rounded bg-blue-50 text-sm font-medium hover:bg-blue-100 transition">
                                        + Add Questions
                                    </button>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        function AttendanceTab() {
            return `
                <div class="max-w-4xl mx-auto">
                    <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                        <h2 class="text-2xl font-semibold text-gray-700">Mark Attendance</h2>
                        <div class="flex items-center space-x-2 bg-white p-2 rounded-lg shadow-sm border border-gray-200">
                            <label class="text-sm font-bold text-gray-600 pl-2">Date:</label>
                            <input type="date" id="attendanceDate" value="${new Date().toISOString().slice(0, 10)}" 
                                class="px-2 py-1 border-none focus:ring-0 text-gray-700 font-medium">
                        </div>
                    </div>
                    <div class="relative mb-6">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><span data-lucide="search" class="text-gray-400 w-5 h-5"></span></div>
                        <input type="text" id="studentSearchInput" placeholder="Search by Student Name or Admission Number..." class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-xl shadow-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-lg transition bg-white" autocomplete="off">
                    </div>
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                        <div class="bg-gray-50 px-4 py-2 border-b border-gray-200 flex justify-between items-center">
                            <span class="text-xs font-bold text-gray-500 uppercase tracking-wider">Student Details</span>
                            <span class="text-xs font-bold text-gray-500 uppercase tracking-wider">Mark Status</span>
                        </div>
                        <div id="attendanceListContainer" class="divide-y divide-gray-100 max-h-[500px] overflow-y-auto">
                            <div class="p-8 text-center text-gray-500 flex flex-col items-center"><span data-lucide="search" class="w-12 h-12 text-gray-300 mb-2"></span><p>Start typing a name or admission number above to find students.</p></div>
                        </div>
                    </div>
                </div>
            `;
        }

        // --- BINDING EVENTS ---

        function bindDashboardEvents() {
            document.querySelectorAll('.nav-item').forEach(item => { item.onclick = () => changeTab(item.getAttribute('data-tab')); });
            if(document.getElementById('logoutBtn')) document.getElementById('logoutBtn').onclick = handleLogout;
            if(document.getElementById('announcementForm')) document.getElementById('announcementForm').onsubmit = handleAddAnnouncement;
            if(document.getElementById('assignmentForm')) document.getElementById('assignmentForm').onsubmit = handleAddAssignment;
            if(document.getElementById('addQuestionForm')) document.getElementById('addQuestionForm').onsubmit = handleAddQuestion;

            const searchInput = document.getElementById('studentSearchInput');
            if (searchInput) {
                searchInput.addEventListener('input', (e) => {
                    const query = e.target.value.trim();
                    if (query.length > 0) filterAttendanceList(query);
                    else {
                        document.getElementById('attendanceListContainer').innerHTML = `<div class="p-8 text-center text-gray-500 flex flex-col items-center"><span data-lucide="search" class="w-12 h-12 text-gray-300 mb-2"></span><p>Start typing a name or admission number above to find students.</p></div>`;
                        lucide.createIcons();
                    }
                });
                searchInput.focus();
            }
        }

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', checkAuth);

    </script>
</body>
</html>
