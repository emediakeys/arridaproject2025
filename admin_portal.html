<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Portal - School Management</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase SDKs (Required to post to Public Home Page) -->
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-compat.js"></script>

    <style>
        /* Custom styles for better dashboard aesthetics */
        :root {
            --primary-color: #10b981; /* Emerald 500 */
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .nav-item {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            cursor: pointer;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
            transition: all 0.2s;
        }
        .nav-item:hover, .nav-item.active {
            background-color: var(--primary-color);
            color: white;
            box-shadow: 0 4px 6px -1px rgba(16, 185, 129, 0.3), 0 2px 4px -2px rgba(16, 185, 129, 0.3);
        }
        /* Style for the action buttons */
        .action-btn {
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            font-weight: 500;
        }
        /* Scrollable container for tables/lists */
        .data-container {
            max-height: 70vh;
            overflow-y: auto;
        }
        /* Comment Section Animation */
        .comment-section {
            transition: max-height 0.3s ease-in-out, opacity 0.3s ease-in-out;
            overflow: hidden;
        }
        /* Hide scrollbar for clean look in comments but allow scroll */
        .custom-scrollbar::-webkit-scrollbar {
            width: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #e5e7eb;
            border-radius: 4px;
        }
        
        /* Mobile Sidebar Transitions */
        .sidebar {
            transition: transform 0.3s ease-in-out;
        }
    </style>
    <!-- Load Lucide icons for clean interface -->
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body>

    <!-- Main Container controlled by JS -->
    <div id="app"></div>

    <script>
        // --- SAFE FIREBASE INITIALIZATION ---
        // We wrap this in try-catch to prevent the portal from crashing if config is missing
        let isFirebaseAvailable = false;
        let db = null;
        let auth = null;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        try {
            if (typeof __firebase_config !== 'undefined') {
                const firebaseConfig = JSON.parse(__firebase_config);
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }
                auth = firebase.auth();
                db = firebase.firestore();
                isFirebaseAvailable = true;
                
                // Initialize Auth for Public Posting
                initFirebaseAuth();
            } else {
                console.warn("Firebase config missing. Public posting will be disabled.");
            }
        } catch (e) {
            console.error("Firebase Init Error:", e);
        }

        // --- ROBUST AUTH INITIALIZATION ---
        async function initFirebaseAuth() {
            if (!isFirebaseAvailable) return;
            
            return new Promise((resolve, reject) => {
                const unsubscribe = auth.onAuthStateChanged(user => {
                    if (user) {
                        unsubscribe();
                        resolve(user);
                    }
                });

                if (!auth.currentUser) {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        auth.signInWithCustomToken(__initial_auth_token).catch(reject);
                    } else {
                        auth.signInAnonymously().catch(reject);
                    }
                }
            });
        }

        // --- APP CONFIGURATION ---
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyMEpK3kKSrQR99hvVBA0fvs-_eWGKHzfQutXHy7X369_ELy0t8BpI-2mrSYnWKVkNX4Q/exec"; 
        
        // --- STATE MANAGEMENT ---
        let adminState = {
            isLoggedIn: false,
            username: '',
            assignedCourse: '',
            activeTab: 'dashboard', 
            students: [],
            announcements: [],
            assignments: [],
            attendance: [],
            loading: false,
            message: null,
            error: false,
            isSidebarOpen: false 
        };

        // --- UTILITY FUNCTIONS ---
        function render(component) {
            const app = document.getElementById('app');
            app.innerHTML = component();
            lucide.createIcons();
            if (adminState.isLoggedIn) {
                bindDashboardEvents();
            } else {
                bindLoginEvents();
            }
        }

        function showMessage(msg, isError = false) {
            adminState.message = msg;
            adminState.error = isError;
            render(adminState.isLoggedIn ? AdminDashboard : AdminLogin); 
        }

        function jsonToUrlParams(data) {
            const params = new URLSearchParams();
            for (const key in data) {
                if (data.hasOwnProperty(key)) {
                    params.append(key, data[key]);
                }
            }
            return params;
        }

        async function fetchAppsScript(action, payload = {}) {
            if(action !== 'toggleLike' && action !== 'addComment') {
                adminState.loading = true;
                render(adminState.isLoggedIn ? AdminDashboard : AdminLogin); 
            }

            const dataToSend = { action, ...payload };
            const formBody = jsonToUrlParams(dataToSend);
            
            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: formBody 
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const responseText = await response.text();
                const result = responseText ? JSON.parse(responseText) : {};
                
                adminState.loading = false;
                return result;

            } catch (error) {
                console.error('API Fetch Error:', error);
                adminState.loading = false;
                return { result: 'error', message: 'Network error. Check console.' };
            }
        }

        // --- AUTHENTICATION ---

        function checkAuth() {
            const storedState = localStorage.getItem('adminState');
            if (storedState) {
                const state = JSON.parse(storedState);
                if (state.isLoggedIn && state.assignedCourse) {
                    adminState = { ...adminState, ...state, isLoggedIn: true };
                    loadInitialData();
                    return;
                }
            }
            adminState.isLoggedIn = false;
            render(AdminLogin);
        }

        function saveAdminState() {
            localStorage.setItem('adminState', JSON.stringify({
                isLoggedIn: adminState.isLoggedIn,
                username: adminState.username,
                assignedCourse: adminState.assignedCourse
            }));
        }

        async function handleAdminLogin(e) {
            e.preventDefault();
            const form = e.target;
            const username = form.username.value.trim();
            const password = form.password.value;

            showMessage('Logging in...');

            const result = await fetchAppsScript('adminLogin', { username, password });

            if (result && result.result === 'success') {
                adminState.isLoggedIn = true;
                adminState.username = username;
                adminState.assignedCourse = result.assignedCourse;
                saveAdminState();
                showMessage('Login successful! Welcome.', false);
                loadInitialData();
            } else {
                adminState.isLoggedIn = false;
                const errMsg = result ? result.message : 'Unknown login error';
                showMessage(errMsg || 'Login failed. Check credentials.', true);
            }
        }

        function handleLogout() {
            localStorage.removeItem('adminState');
            adminState = { 
                isLoggedIn: false, 
                username: '', 
                assignedCourse: '', 
                activeTab: 'dashboard', 
                students: [], announcements: [], assignments: [], attendance: [],
                isSidebarOpen: false
            };
            render(AdminLogin);
        }

        function bindLoginEvents() {
            const loginForm = document.getElementById('adminLoginForm');
            if (loginForm) {
                loginForm.addEventListener('submit', handleAdminLogin);
            }
        }

        // --- DATA LOADING & DASHBOARD MANAGEMENT ---

        async function loadInitialData() {
            if (!adminState.isLoggedIn) return;
            
            if(adminState.students.length === 0) {
                adminState.loading = true;
                render(AdminDashboard);
            }

            const course = adminState.assignedCourse;

            try {
                const [studentsResult, announcementsResult, assignmentsResult] = await Promise.all([
                    fetchAppsScript('getStudentsByCourse', { course }),
                    fetchAppsScript('getAnnouncementsByCourse', { course, currentUser: adminState.username }),
                    fetchAppsScript('getAssignmentsByCourse', { course })
                ]);

                adminState.students = studentsResult && studentsResult.result === 'success' ? studentsResult.data : [];
                adminState.announcements = announcementsResult && announcementsResult.result === 'success' ? announcementsResult.data : [];
                adminState.assignments = assignmentsResult && assignmentsResult.result === 'success' ? assignmentsResult.data : [];
            } catch (err) {
                console.error("Error loading dashboard data", err);
            }
            
            adminState.loading = false;
            render(AdminDashboard);
        }

        function changeTab(tabName) {
            adminState.activeTab = tabName;
            adminState.message = null; 
            if(window.innerWidth < 768) {
                adminState.isSidebarOpen = false;
            }
            render(AdminDashboard);
        }

        function toggleSidebar() {
            adminState.isSidebarOpen = !adminState.isSidebarOpen;
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            
            if (adminState.isSidebarOpen) {
                sidebar.classList.remove('-translate-x-full');
                sidebar.classList.add('translate-x-0');
                overlay.classList.remove('hidden');
            } else {
                sidebar.classList.add('-translate-x-full');
                sidebar.classList.remove('translate-x-0');
                overlay.classList.add('hidden');
            }
        }

        // --- CRUD OPERATIONS ---

        async function handleAddAnnouncement(e) {
            e.preventDefault();
            const form = e.target;
            const title = form.title.value;
            const content = form.content.value;
            const visibility = form.visibility.value; 
            const course = adminState.assignedCourse;
            
            showMessage('Adding Announcement...');
            
            // INDEPENDENT OPERATIONS: Try both Apps Script AND Firebase separately
            let scriptSuccess = false;
            let firebaseSuccess = false;
            let scriptMsg = '';

            // 1. Internal System (Apps Script)
            try {
                const result = await fetchAppsScript('addAnnouncement', { course, title, content, visibility });
                if (result.result === 'success') {
                    scriptSuccess = true;
                } else {
                    scriptMsg = result.message || 'Script error';
                }
            } catch (err) {
                scriptMsg = 'Connection error';
            }

            // 2. Public Feed (Firebase) - Only if visibility is public
            if (visibility === 'public') {
                if (isFirebaseAvailable && db) {
                    try {
                        if (!auth.currentUser) await initFirebaseAuth();

                        await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('news_posts').add({
                            title: title,
                            content: content,
                            authorName: adminState.username || 'Admin Staff',
                            authorInitials: (adminState.username || 'A').charAt(0).toUpperCase(),
                            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                            likes: 0,
                            likedBy: [],
                            comments: [],
                            type: 'public'
                        });
                        firebaseSuccess = true;
                        console.log("Posted to public feed successfully.");
                    } catch (err) {
                        console.error("Failed to post to public feed:", err);
                    }
                } else {
                    console.warn("Public post skipped for website feed: Database not connected.");
                }
            } else {
                // If private, we assume success on firebase side (as we don't need it)
                firebaseSuccess = true; 
            }

            // Reporting
            if (scriptSuccess && (visibility === 'private' || firebaseSuccess)) {
                showMessage(`Announcement posted successfully!`, false);
                form.reset();
                loadInitialData();
            } else if (firebaseSuccess && !scriptSuccess) {
                showMessage(`Posted to Website Feed ONLY. Database update failed: ${scriptMsg}`, true);
                form.reset();
                loadInitialData(); // Reload to see if partial data exists
            } else {
                showMessage(`Failed to post announcement. ${scriptMsg}`, true);
            }
        }

        async function handleAddAssignment(e) {
            e.preventDefault();
            const form = e.target;
            const title = form.title.value;
            const description = form.description.value;
            const dueDate = form.dueDate.value;
            const course = adminState.assignedCourse;

            showMessage('Adding Assignment...');
            
            const result = await fetchAppsScript('addAssignment', { course, title, description, dueDate });

            if (result.result === 'success') {
                showMessage('Assignment added successfully!', false);
                form.reset();
                loadInitialData(); 
            } else {
                showMessage(result.message || 'Failed.', true);
            }
        }

        async function handleRemoveStudent(admNo, course) {
            if(!confirm(`Are you sure you want to remove student ${admNo}?`)) return;
            
            showMessage(`Removing student ${admNo}...`);
            
            const result = await fetchAppsScript('removeStudent', { admNo, course });

            if (result.result === 'success') {
                showMessage(`Student ${admNo} removed.`, false);
                adminState.students = adminState.students.filter(s => s.admNo !== admNo);
                render(AdminDashboard); 
            } else {
                showMessage(result.message || 'Failed.', true);
            }
        }

        // --- ATTENDANCE LOGIC ---

        function filterAttendanceList(query) {
            const listContainer = document.getElementById('attendanceListContainer');
            const lowerQuery = query.toLowerCase();
            
            const filteredStudents = adminState.students.filter(s => 
                s.firstName.toLowerCase().includes(lowerQuery) || 
                s.lastName.toLowerCase().includes(lowerQuery) || 
                String(s.admNo).toLowerCase().includes(lowerQuery)
            );

            if (filteredStudents.length === 0) {
                listContainer.innerHTML = `<div class="p-8 text-center text-gray-500">No students found matching "${query}"</div>`;
                return;
            }

            listContainer.innerHTML = filteredStudents.map(student => `
                <div class="flex items-center justify-between p-4 border-b border-gray-100 hover:bg-gray-50 transition">
                    <div class="flex items-center space-x-4">
                        <div class="bg-indigo-100 text-indigo-700 w-10 h-10 rounded-full flex items-center justify-center font-bold text-xs">
                            ${student.admNo}
                        </div>
                        <div>
                            <p class="font-semibold text-gray-800">${student.firstName} ${student.lastName}</p>
                            <p class="text-xs text-gray-500">${student.email}</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-2">
                        <select id="status-${student.admNo}" class="text-sm border-gray-300 rounded-md shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 p-2 border">
                            <option value="Present">Present</option>
                            <option value="Absent">Absent</option>
                            <option value="Late">Late</option>
                            <option value="Excused">Excused</option>
                        </select>
                        <button onclick="handleQuickAttendance('${student.admNo}')" 
                                class="bg-indigo-600 hover:bg-indigo-700 text-white p-2 rounded-md shadow transition flex items-center">
                            <span data-lucide="check" class="w-4 h-4"></span>
                            <span class="ml-2 text-xs font-bold uppercase hidden md:inline">Save</span>
                        </button>
                    </div>
                </div>
            `).join('');
            
            lucide.createIcons(); 
        }

        async function handleQuickAttendance(admNo) {
            const date = document.getElementById('attendanceDate').value;
            const statusSelect = document.getElementById(`status-${admNo}`);
            const status = statusSelect.value;
            const course = adminState.assignedCourse;

            const btn = statusSelect.nextElementSibling;
            const originalContent = btn.innerHTML;
            btn.innerHTML = `<span class="animate-spin w-4 h-4 border-2 border-white border-t-transparent rounded-full"></span>`;
            btn.disabled = true;

            const result = await fetchAppsScript('recordAttendance', { admNo, status, date, course });

            if (result.result === 'success') {
                btn.innerHTML = `<span data-lucide="check-circle" class="w-4 h-4"></span>`;
                btn.classList.replace('bg-indigo-600', 'bg-green-500');
                btn.classList.replace('hover:bg-indigo-700', 'hover:bg-green-600');
                
                const toast = document.getElementById('toastMsg');
                toast.innerText = `Recorded: ${admNo} is ${status}`;
                toast.classList.remove('opacity-0', 'translate-y-4');
                setTimeout(() => {
                    toast.classList.add('opacity-0', 'translate-y-4');
                    btn.innerHTML = originalContent;
                    btn.classList.replace('bg-green-500', 'bg-indigo-600');
                    btn.classList.replace('hover:bg-green-600', 'hover:bg-indigo-700');
                    btn.disabled = false;
                    lucide.createIcons();
                }, 2000);
            } else {
                alert("Failed to record attendance: " + result.message);
                btn.innerHTML = originalContent;
                btn.disabled = false;
                lucide.createIcons();
            }
        }

        // --- SOCIAL INTERACTIONS (For viewing own posts in feed) ---

       // --- SOCIAL INTERACTIONS (Improved with Error Handling) ---

        async function toggleLike(annId, btnElement) {
            const icon = btnElement.querySelector('.like-icon');
            const countSpan = btnElement.querySelector('.like-count');
            
            let text = countSpan.innerText;
            let currentCount = (text === 'Like') ? 0 : parseInt(text);
            const isLiked = icon.classList.contains('fill-current') && icon.classList.contains('text-red-500');

            // 1. Optimistic UI Update (Instant feedback)
            if (isLiked) {
                icon.classList.remove('fill-current', 'text-red-500');
                icon.classList.add('text-gray-500');
                const newCount = currentCount - 1;
                countSpan.innerText = newCount > 0 ? newCount : 'Like';
            } else {
                icon.classList.add('fill-current', 'text-red-500');
                icon.classList.remove('text-gray-500');
                countSpan.innerText = currentCount + 1;
            }

            // 2. Send to Backend
            const result = await fetchAppsScript('toggleLike', { 
                announcementId: annId, 
                user: adminState.username 
            });

            // 3. Revert if failed
            if (!result || result.result !== 'success') {
                console.error("Like failed on server:", result);
                // Revert UI changes
                if (isLiked) {
                    icon.classList.add('fill-current', 'text-red-500');
                    icon.classList.remove('text-gray-500');
                    countSpan.innerText = currentCount; 
                } else {
                    icon.classList.remove('fill-current', 'text-red-500');
                    icon.classList.add('text-gray-500');
                    countSpan.innerText = currentCount === 0 ? 'Like' : currentCount;
                }
                alert("Could not save like. Ensure 'Likes' sheet exists.");
            }
        }

        async function postComment(annId) {
            const input = document.getElementById(`comment-input-${annId}`);
            const text = input.value.trim();
            if(!text) return;

            const list = document.getElementById(`comment-list-${annId}`);
            const emptyMsg = list.querySelector('.empty-msg');
            if(emptyMsg) emptyMsg.remove();

            // 1. Create Temporary ID for the comment to remove it if failed
            const tempId = 'temp-' + Date.now();

            const tempComment = `
                <div id="${tempId}" class="flex space-x-3 group animate-pulse opacity-70">
                    <div class="w-8 h-8 rounded-full bg-emerald-100 flex-shrink-0 flex items-center justify-center text-emerald-600 text-xs font-bold">
                        ME
                    </div>
                    <div class="flex-1">
                        <div class="bg-white p-3 rounded-2xl rounded-tl-none shadow-sm inline-block min-w-[150px] border border-gray-100">
                            <div class="flex justify-between items-baseline mb-1">
                                <span class="text-xs font-bold text-gray-900">Me</span>
                                <span class="text-[10px] text-gray-400 ml-2">Saving...</span>
                            </div>
                            <p class="text-sm text-gray-700">${text}</p>
                        </div>
                    </div>
                </div>
            `;
            list.insertAdjacentHTML('beforeend', tempComment);
            input.value = '';

            // 2. Send to Backend
            const result = await fetchAppsScript('addComment', { 
                announcementId: annId, 
                user: adminState.username, 
                comment: text 
            });

            const tempEl = document.getElementById(tempId);

            // 3. Handle Result
            if (result && result.result === 'success') {
                // Success: Remove pulse animation and 'Saving...' text
                if(tempEl) {
                    tempEl.classList.remove('animate-pulse', 'opacity-70');
                    tempEl.querySelector('span.text-gray-400').innerText = 'Just now';
                }
            } else {
                // Failure: Remove the comment and alert
                if(tempEl) tempEl.remove();
                input.value = text; // Put text back in box
                alert("Failed to post comment. Ensure 'Comments' sheet exists.");
            }
        }


        // --- UI COMPONENTS ---

        function AdminLogin() {
            const statusMessage = adminState.message || '';
            return `
                <div class="min-h-screen flex items-center justify-center p-4">
                    <div class="w-full max-w-md bg-white p-8 rounded-xl shadow-2xl border border-gray-100">
                        <div class="text-center mb-8">
                            <h2 class="text-3xl font-extrabold text-gray-900">Admin Login</h2>
                            <p class="mt-2 text-sm text-gray-600">School Management System</p>
                        </div>
                        <form id="adminLoginForm" class="space-y-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Username</label>
                                <input type="text" name="username" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                                <input type="password" name="password" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500">
                            </div>
                            <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-emerald-600 hover:bg-emerald-700 transition">
                                <span data-lucide="log-in" class="w-5 h-5 mr-2"></span> Log In
                            </button>
                        </form>
                        ${statusMessage ? `<p class="mt-4 text-center text-sm ${adminState.error ? 'text-red-600' : 'text-emerald-600'}">${statusMessage}</p>` : ''}
                    </div>
                </div>
            `;
        }

        function AdminDashboard() {
            const tabs = [
                { id: 'dashboard', name: 'Dashboard', icon: 'layout-dashboard' },
                { id: 'students', name: 'Students', icon: 'users' },
                { id: 'announcements', name: 'Announcements', icon: 'megaphone' },
                { id: 'assignments', name: 'Assignments', icon: 'clipboard-list' },
                { id: 'attendance', name: 'Attendance', icon: 'calendar-check' },
            ];

            // Determine Sidebar Classes based on State
            const sidebarClasses = adminState.isSidebarOpen ? 'translate-x-0' : '-translate-x-full';
            const overlayClasses = adminState.isSidebarOpen ? '' : 'hidden';

            return `
                <div class="min-h-screen flex relative overflow-hidden bg-gray-50">
                    
                    <!-- Mobile Sidebar Overlay -->
                    <div id="sidebarOverlay" onclick="toggleSidebar()" 
                        class="fixed inset-0 bg-black bg-opacity-50 z-40 transition-opacity duration-300 md:hidden ${overlayClasses}">
                    </div>

                    <!-- Sidebar (Mobile Off-canvas + Desktop Static) -->
                    <div id="sidebar" class="sidebar fixed inset-y-0 left-0 z-50 w-64 bg-gray-800 text-white flex flex-col shadow-2xl transform transition-transform duration-300 ease-in-out md:translate-x-0 md:static md:inset-auto ${sidebarClasses}">
                        
                        <!-- Sidebar Header -->
                        <div class="flex-shrink-0 flex items-center justify-between p-4 border-b border-gray-700">
                            <div class="flex items-center font-bold text-lg">
                                <span data-lucide="graduation-cap" class="w-6 h-6 mr-2 text-emerald-400"></span>
                                <span>Admin Panel</span>
                            </div>
                            <!-- Mobile Close Button -->
                            <button onclick="toggleSidebar()" class="md:hidden text-gray-400 hover:text-white cursor-pointer">
                                <span data-lucide="x" class="w-6 h-6"></span>
                            </button>
                        </div>
                        
                        <!-- User Info -->
                        <div class="p-4 border-b border-gray-700 bg-gray-900/30">
                            <p class="font-semibold text-sm truncate">${adminState.username}</p>
                            <p class="text-xs text-gray-400 mt-1 truncate">Course: ${adminState.assignedCourse}</p>
                        </div>

                        <!-- Navigation -->
                        <nav class="flex-grow p-4 space-y-1 overflow-y-auto">
                            ${tabs.map(tab => `
                                <div class="nav-item ${adminState.activeTab === tab.id ? 'active' : 'text-gray-300 hover:bg-gray-700 hover:text-white'}" 
                                     data-tab="${tab.id}">
                                    <span data-lucide="${tab.icon}" class="w-5 h-5 mr-3"></span>
                                    ${tab.name}
                                </div>
                            `).join('')}
                        </nav>

                        <!-- Logout -->
                        <div class="p-4 border-t border-gray-700">
                            <button id="logoutBtn" class="w-full flex items-center justify-center p-3 text-red-400 hover:bg-gray-700 rounded-lg transition duration-150 group">
                                <span data-lucide="log-out" class="w-5 h-5 mr-2 group-hover:text-red-300"></span> Logout
                            </button>
                        </div>
                    </div>

                    <!-- Main Content -->
                    <main class="flex-grow flex flex-col h-screen overflow-hidden relative">
                        
                        <!-- Mobile Header (Visible only on mobile) -->
                        <div class="md:hidden bg-white shadow-sm border-b border-gray-200 p-4 flex items-center justify-between flex-shrink-0 z-30">
                            <div class="flex items-center">
                                <button onclick="toggleSidebar()" class="mr-3 text-gray-600 hover:text-emerald-600 focus:outline-none cursor-pointer">
                                    <span data-lucide="menu" class="w-6 h-6"></span>
                                </button>
                                <h1 class="text-lg font-bold text-gray-800">
                                    ${tabs.find(t => t.id === adminState.activeTab).name}
                                </h1>
                            </div>
                            <div class="w-8 h-8 bg-emerald-100 rounded-full flex items-center justify-center text-emerald-600 font-bold text-xs">
                                AD
                            </div>
                        </div>

                        <!-- Content Scroll Area -->
                        <div class="flex-grow overflow-y-auto p-4 md:p-8">
                            <!-- Desktop Title -->
                            <h1 class="text-3xl font-bold text-gray-800 mb-6 hidden md:block">
                                ${tabs.find(t => t.id === adminState.activeTab).name} Management
                            </h1>

                            <!-- Toast Notification Container -->
                            <div id="toastMsg" class="fixed bottom-4 right-4 bg-gray-800 text-white px-6 py-3 rounded-lg shadow-lg transform transition-all duration-300 opacity-0 translate-y-4 z-50 flex items-center">
                                <span data-lucide="info" class="w-4 h-4 mr-2"></span>
                                <span>Notification</span>
                            </div>

                            <div class="min-h-[500px]">
                                ${adminState.loading ? LoadingSpinner() : renderActiveTabContent()}
                            </div>
                        </div>
                    </main>
                </div>
            `;
        }
        
        function LoadingSpinner() {
            return `
                <div class="flex flex-col items-center justify-center py-20">
                    <svg class="animate-spin -ml-1 mr-3 h-10 w-10 text-emerald-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <p class="mt-4 text-gray-600">Loading data...</p>
                </div>
            `;
        }

        function renderActiveTabContent() {
            switch (adminState.activeTab) {
                case 'dashboard': return DashboardTab();
                case 'students': return StudentList();
                case 'announcements': return AnnouncementsTab();
                case 'assignments': return AssignmentsTab();
                case 'attendance': return AttendanceTab();
                default: return `<p>Select a tab.</p>`;
            }
        }

        // --- TAB CONTENTS ---

        function DashboardTab() {
            const studentCount = adminState.students.length;
            const assignmentCount = adminState.assignments.length;
            const announcementCount = adminState.announcements.length;

            return `
                <h2 class="text-2xl font-semibold mb-6 text-gray-700 hidden md:block">Course: ${adminState.assignedCourse}</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-blue-500 flex justify-between items-center">
                        <div><p class="text-sm font-medium text-gray-500">Total Students</p><p class="text-3xl font-extrabold text-gray-800 mt-1">${studentCount}</p></div>
                        <div class="p-3 bg-blue-50 rounded-lg text-blue-500"><span data-lucide="users" class="w-6 h-6"></span></div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-yellow-500 flex justify-between items-center">
                        <div><p class="text-sm font-medium text-gray-500">Active Assignments</p><p class="text-3xl font-extrabold text-gray-800 mt-1">${assignmentCount}</p></div>
                        <div class="p-3 bg-yellow-50 rounded-lg text-yellow-500"><span data-lucide="clipboard-list" class="w-6 h-6"></span></div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-emerald-500 flex justify-between items-center">
                        <div><p class="text-sm font-medium text-gray-500">Total Announcements</p><p class="text-3xl font-extrabold text-gray-800 mt-1">${announcementCount}</p></div>
                        <div class="p-3 bg-emerald-50 rounded-lg text-emerald-500"><span data-lucide="megaphone" class="w-6 h-6"></span></div>
                    </div>
                </div>
            `;
        }

        function StudentList() {
            return `
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                    <div class="p-4 border-b border-gray-200 flex justify-between items-center bg-gray-50">
                        <h2 class="text-lg font-bold text-gray-800">Student Directory</h2>
                        <span class="bg-gray-200 text-gray-700 text-xs px-2 py-1 rounded-full font-bold">${adminState.students.length}</span>
                    </div>
                    ${adminState.students.length === 0 ? `<p class="p-8 text-center text-gray-500">No students found.</p>` : `
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Adm. No</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Action</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    ${adminState.students.map(s => `
                                        <tr>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${s.admNo}</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${s.firstName} ${s.lastName}</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm">
                                                <button onclick="handleRemoveStudent('${s.admNo}', '${adminState.assignedCourse}')" class="text-red-600 hover:text-red-900 bg-red-50 px-3 py-1 rounded-md font-medium text-xs transition">Remove</button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>`}
                </div>
            `;
        }

        function AnnouncementsTab() {
            return `
                <div class="max-w-5xl mx-auto">
                    <div class="flex flex-col lg:flex-row gap-6">
                        <!-- Post Creator -->
                        <div class="lg:w-1/3 order-1">
                            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4 lg:sticky lg:top-4">
                                <h2 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                                    <span data-lucide="pen-tool" class="w-5 h-5 mr-2 text-emerald-600"></span>
                                    Create Post
                                </h2>
                                <form id="announcementForm" class="space-y-4">
                                    <div>
                                        <input type="text" name="title" required placeholder="Post Title" 
                                            class="w-full px-4 py-2 bg-gray-50 border border-gray-200 rounded-lg focus:bg-white focus:ring-2 focus:ring-emerald-500 focus:border-transparent transition-all outline-none text-sm font-semibold text-gray-800">
                                    </div>
                                    <div>
                                        <textarea name="content" rows="4" required placeholder="What's happening in ${adminState.assignedCourse}?" 
                                            class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-lg focus:bg-white focus:ring-2 focus:ring-emerald-500 focus:border-transparent transition-all outline-none text-sm resize-none"></textarea>
                                    </div>
                                    
                                    <!-- Visibility Toggle -->
                                    <div>
                                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Visibility</label>
                                        <select name="visibility" class="w-full px-4 py-2 bg-gray-50 border border-gray-200 rounded-lg focus:bg-white focus:ring-2 focus:ring-emerald-500 focus:border-transparent transition-all outline-none text-sm text-gray-800">
                                            <option value="public" selected>üåç Public (Home Page & Students)</option>
                                            <option value="private">üîí Private (Course Students Only)</option>
                                        </select>
                                    </div>

                                    <button type="submit" class="w-full py-2.5 bg-emerald-600 hover:bg-emerald-700 text-white font-medium rounded-lg shadow-md hover:shadow-lg transition-all duration-200 flex items-center justify-center transform active:scale-95">
                                        <span data-lucide="send" class="w-4 h-4 mr-2"></span>
                                        Post Update
                                    </button>
                                </form>
                            </div>
                        </div>

                        <!-- News Feed -->
                        <div class="lg:w-2/3 order-2">
                            <div class="flex items-center justify-between mb-4 px-1">
                                <h2 class="text-xl font-bold text-gray-800">News Feed</h2>
                                <span class="text-xs font-medium text-gray-500 bg-white px-2 py-1 rounded-full border shadow-sm">
                                    ${adminState.announcements.length} Posts
                                </span>
                            </div>
                            
                            <div class="space-y-5 pb-20">
                                ${adminState.announcements.length === 0 ? 
                                    `<div class="bg-white rounded-xl shadow-sm border border-gray-200 p-8 text-center">
                                        <div class="mx-auto w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mb-4">
                                            <span data-lucide="coffee" class="w-8 h-8 text-gray-400"></span>
                                        </div>
                                        <h3 class="text-lg font-medium text-gray-900">No posts yet</h3>
                                        <p class="text-gray-500 mt-1">Be the first to post an update for your students.</p>
                                    </div>` : 
                                    adminState.announcements.map((a, index) => {
                                        const likes = a.likes || 0;
                                        const comments = a.comments || [];
                                        const likedByMe = a.likedByMe || false;
                                        const annId = a.id;
                                        const initials = "AD"; 
                                        const isPublic = a.visibility === 'public' || a.type === 'public';
                                        
                                        return `
                                        <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden transition-shadow hover:shadow-md">
                                            <!-- Post Header -->
                                            <div class="p-4 flex items-center space-x-3">
                                                <div class="w-10 h-10 rounded-full bg-gradient-to-br from-emerald-500 to-teal-600 flex items-center justify-center text-white font-bold text-sm shadow-sm">
                                                    ${initials}
                                                </div>
                                                <div class="flex-1 min-w-0">
                                                    <p class="text-sm font-bold text-gray-900 truncate">
                                                        ${adminState.username || 'Administrator'}
                                                        ${isPublic ? '<span class="ml-2 text-[10px] bg-blue-100 text-blue-600 px-1.5 py-0.5 rounded-full uppercase tracking-wider">Public</span>' : '<span class="ml-2 text-[10px] bg-gray-100 text-gray-600 px-1.5 py-0.5 rounded-full uppercase tracking-wider">Private</span>'}
                                                    </p>
                                                    <p class="text-xs text-gray-500 flex items-center">
                                                        <span>${a.date}</span>
                                                        <span class="mx-1">‚Ä¢</span>
                                                        <span class="text-emerald-600 font-medium bg-emerald-50 px-1.5 rounded text-[10px]">Admin</span>
                                                    </p>
                                                </div>
                                                <button class="text-gray-400 hover:text-gray-600">
                                                    <span data-lucide="more-horizontal" class="w-5 h-5"></span>
                                                </button>
                                            </div>

                                            <!-- Post Content -->
                                            <div class="px-4 pb-2">
                                                <h3 class="text-base font-bold text-gray-900 mb-2 leading-tight">${a.title}</h3>
                                                <div class="text-sm text-gray-700 leading-relaxed whitespace-pre-wrap">${a.content}</div>
                                            </div>

                                            <!-- Interaction Stats (if any) -->
                                            ${(likes > 0 || comments.length > 0) ? `
                                            <div class="px-4 py-2 flex items-center justify-between text-xs text-gray-500 border-b border-gray-50">
                                                <div class="flex items-center">
                                                    ${likes > 0 ? `<div class="flex -space-x-1 mr-2">
                                                        <div class="w-4 h-4 rounded-full bg-red-500 flex items-center justify-center border border-white">
                                                            <span data-lucide="heart" class="w-2 h-2 text-white fill-current"></span>
                                                        </div>
                                                    </div>
                                                    <span>${likes}</span>` : ''}
                                                </div>
                                                <div>
                                                    ${comments.length > 0 ? `<span>${comments.length} comments</span>` : ''}
                                                </div>
                                            </div>` : ''}

                                            <!-- Action Buttons -->
                                            <div class="px-2 py-1 flex items-center justify-between border-t border-gray-100">
                                                <button onclick="toggleLike('${annId}', this)" 
                                                    class="flex-1 flex items-center justify-center py-2 space-x-2 rounded-lg hover:bg-gray-50 transition active:scale-95 group">
                                                    <span data-lucide="heart" class="like-icon w-5 h-5 ${likedByMe ? 'fill-current text-red-500' : 'text-gray-500 group-hover:text-gray-600'} transition-colors"></span>
                                                    <span class="text-sm font-medium ${likedByMe ? 'text-red-500' : 'text-gray-600'} like-count">${likes > 0 ? likes : 'Like'}</span>
                                                </button>
                                                
                                                <button onclick="document.getElementById('comments-${index}').classList.toggle('hidden')" 
                                                    class="flex-1 flex items-center justify-center py-2 space-x-2 rounded-lg hover:bg-gray-50 transition active:scale-95 text-gray-600">
                                                    <span data-lucide="message-circle" class="w-5 h-5"></span>
                                                    <span class="text-sm font-medium">Comment</span>
                                                </button>
                                                
                                                <button class="flex-1 flex items-center justify-center py-2 space-x-2 rounded-lg hover:bg-gray-50 transition active:scale-95 text-gray-600">
                                                    <span data-lucide="share-2" class="w-5 h-5"></span>
                                                    <span class="text-sm font-medium">Share</span>
                                                </button>
                                            </div>

                                            <!-- Comments Section -->
                                            <div id="comments-${index}" class="hidden bg-gray-50 border-t border-gray-100 p-4">
                                                <!-- Comment List -->
                                                <div class="space-y-4 mb-4 max-h-60 overflow-y-auto custom-scrollbar" id="comment-list-${annId}">
                                                    ${comments.length === 0 ? 
                                                        `<div class="empty-msg text-center py-4">
                                                            <p class="text-xs text-gray-400 italic">No comments yet. Start the conversation!</p>
                                                        </div>` :
                                                        comments.map(c => `
                                                            <div class="flex space-x-3 group">
                                                                <div class="w-8 h-8 rounded-full bg-blue-100 flex-shrink-0 flex items-center justify-center text-blue-600 text-xs font-bold">
                                                                    ${c.user.charAt(0)}
                                                                </div>
                                                                <div class="flex-1">
                                                                    <div class="bg-white p-3 rounded-2xl rounded-tl-none shadow-sm inline-block min-w-[150px]">
                                                                        <div class="flex justify-between items-baseline mb-1">
                                                                            <span class="text-xs font-bold text-gray-900">${c.user}</span>
                                                                            <span class="text-[10px] text-gray-400 ml-2">${c.time}</span>
                                                                        </div>
                                                                        <p class="text-sm text-gray-700">${c.text}</p>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        `).join('')
                                                    }
                                                </div>
                                                
                                                <!-- Input Area -->
                                                <div class="flex items-center space-x-2 bg-white p-1.5 rounded-full border border-gray-300 shadow-sm focus-within:border-emerald-500 focus-within:ring-1 focus-within:ring-emerald-500 transition-all">
                                                    <div class="w-8 h-8 rounded-full bg-emerald-100 flex items-center justify-center text-emerald-700 text-xs font-bold ml-1">
                                                        AD
                                                    </div>
                                                    <input type="text" id="comment-input-${annId}" 
                                                        placeholder="Write a comment..." 
                                                        class="flex-1 bg-transparent border-none focus:ring-0 text-sm px-2 py-1"
                                                        onkeydown="if(event.key === 'Enter') postComment('${annId}')">
                                                    <button onclick="postComment('${annId}')" 
                                                        class="w-8 h-8 bg-emerald-600 text-white rounded-full flex items-center justify-center hover:bg-emerald-700 transition shadow-sm">
                                                        <span data-lucide="send" class="w-4 h-4 ml-0.5"></span>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                        `;
                                    }).join('')
                                }
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function AssignmentsTab() {
            return `
                <div class="grid md:grid-cols-2 gap-8">
                    <div>
                        <h2 class="text-2xl font-semibold mb-4 text-gray-700">New Assignment</h2>
                        <form id="assignmentForm" class="space-y-4 bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                            <input type="text" name="title" required placeholder="Title" class="w-full px-3 py-2 border rounded-lg bg-gray-50 focus:bg-white transition">
                            <textarea name="description" rows="4" required placeholder="Details" class="w-full px-3 py-2 border rounded-lg bg-gray-50 focus:bg-white transition"></textarea>
                            <input type="date" name="dueDate" required class="w-full px-3 py-2 border rounded-lg bg-gray-50 focus:bg-white transition">
                            <button type="submit" class="action-btn bg-blue-600 text-white w-full hover:bg-blue-700 transition shadow-md">Create</button>
                        </form>
                    </div>
                    <div>
                        <h2 class="text-2xl font-semibold mb-4 text-gray-700">Active</h2>
                        <div class="space-y-4 data-container max-h-96 overflow-y-auto">
                             ${adminState.assignments.map(a => `
                                <div class="p-4 border rounded-lg bg-white shadow-sm border-l-4 border-blue-500">
                                    <p class="font-bold text-gray-900">${a.title}</p>
                                    <p class="text-sm text-gray-600 mt-1">${a.description}</p>
                                    <p class="text-xs mt-2 font-medium text-blue-600 bg-blue-50 inline-block px-2 py-1 rounded">Due: ${a.dueDate}</p>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        function AttendanceTab() {
            // Updated Tab with Search capabilities
            return `
                <div class="max-w-4xl mx-auto">
                    <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                        <h2 class="text-2xl font-semibold text-gray-700">Mark Attendance</h2>
                        <div class="flex items-center space-x-2 bg-white p-2 rounded-lg shadow-sm border border-gray-200">
                            <label class="text-sm font-bold text-gray-600 pl-2">Date:</label>
                            <input type="date" id="attendanceDate" value="${new Date().toISOString().slice(0, 10)}" 
                                class="px-2 py-1 border-none focus:ring-0 text-gray-700 font-medium">
                        </div>
                    </div>

                    <!-- Search Bar -->
                    <div class="relative mb-6">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <span data-lucide="search" class="text-gray-400 w-5 h-5"></span>
                        </div>
                        <input type="text" id="studentSearchInput" placeholder="Search by Student Name or Admission Number..." 
                            class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-xl shadow-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-lg transition bg-white"
                            autocomplete="off">
                    </div>

                    <!-- Results List -->
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                        <div class="bg-gray-50 px-4 py-2 border-b border-gray-200 flex justify-between items-center">
                            <span class="text-xs font-bold text-gray-500 uppercase tracking-wider">Student Details</span>
                            <span class="text-xs font-bold text-gray-500 uppercase tracking-wider">Mark Status</span>
                        </div>
                        
                        <div id="attendanceListContainer" class="divide-y divide-gray-100 max-h-[500px] overflow-y-auto">
                            <!-- List items injected here via JS -->
                            <div class="p-8 text-center text-gray-500 flex flex-col items-center">
                                <span data-lucide="search" class="w-12 h-12 text-gray-300 mb-2"></span>
                                <p>Start typing a name or admission number above to find students.</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // --- BINDING EVENTS ---

        function bindDashboardEvents() {
            // Tab switching
            document.querySelectorAll('.nav-item').forEach(item => {
                item.onclick = () => changeTab(item.getAttribute('data-tab'));
            });

            // Logout
            const logoutBtn = document.getElementById('logoutBtn');
            if(logoutBtn) logoutBtn.onclick = handleLogout;
            
            // Basic Forms
            const announcementForm = document.getElementById('announcementForm');
            if(announcementForm) announcementForm.onsubmit = handleAddAnnouncement;
            
            const assignmentForm = document.getElementById('assignmentForm');
            if(assignmentForm) assignmentForm.onsubmit = handleAddAssignment;

            // --- SEARCH EVENT BINDING ---
            const searchInput = document.getElementById('studentSearchInput');
            if (searchInput) {
                searchInput.addEventListener('input', (e) => {
                    const query = e.target.value.trim();
                    if (query.length > 0) {
                        filterAttendanceList(query);
                    } else {
                        document.getElementById('attendanceListContainer').innerHTML = `
                             <div class="p-8 text-center text-gray-500 flex flex-col items-center">
                                <span data-lucide="search" class="w-12 h-12 text-gray-300 mb-2"></span>
                                <p>Start typing a name or admission number above to find students.</p>
                            </div>
                        `;
                        lucide.createIcons();
                    }
                });
                // Focus the input automatically if we just switched to this tab
                searchInput.focus();
            }
        }

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', checkAuth);

    </script>
</body>
</html>
