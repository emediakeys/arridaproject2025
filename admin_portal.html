<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Portal - School Management</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for better dashboard aesthetics */
        :root {
            --primary-color: #10b981; /* Emerald 500 */
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .sidebar {
            transition: width 0.3s ease;
        }
        .nav-item {
            display: flex;
            align-items: center;
            padding: 1rem 1.5rem;
            cursor: pointer;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
        }
        .nav-item:hover, .nav-item.active {
            background-color: var(--primary-color);
            color: white;
            box-shadow: 0 4px 6px -1px rgba(16, 185, 129, 0.3), 0 2px 4px -2px rgba(16, 185, 129, 0.3);
        }
        /* Style for the action buttons */
        .action-btn {
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            font-weight: 500;
        }
        /* Scrollable container for tables/lists */
        .data-container {
            max-height: 70vh;
            overflow-y: auto;
        }
        /* Comment Section Animation */
        .comment-section {
            transition: max-height 0.3s ease-in-out, opacity 0.3s ease-in-out;
            overflow: hidden;
        }
    </style>
    <!-- Load Lucide icons for clean interface -->
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body>

    <!-- Main Container controlled by JS -->
    <div id="app"></div>

    <script>
        // --- CONFIGURATION ---
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyMEpK3kKSrQR99hvVBA0fvs-_eWGKHzfQutXHy7X369_ELy0t8BpI-2mrSYnWKVkNX4Q/exec"; 
        
        // --- STATE MANAGEMENT ---
        let adminState = {
            isLoggedIn: false,
            username: '',
            assignedCourse: '',
            activeTab: 'dashboard', 
            students: [],
            announcements: [],
            assignments: [],
            attendance: [],
            loading: false,
            message: null,
            error: false
        };

        // --- UTILITY FUNCTIONS ---
        function render(component) {
            const app = document.getElementById('app');
            app.innerHTML = component();
            // Re-render icons after adding HTML
            lucide.createIcons();
            // Bind events after render
            if (adminState.isLoggedIn) {
                bindDashboardEvents();
            } else {
                bindLoginEvents();
            }
        }

        function showMessage(msg, isError = false) {
            adminState.message = msg;
            adminState.error = isError;
            render(adminState.isLoggedIn ? AdminDashboard : AdminLogin); 
        }

        function jsonToUrlParams(data) {
            const params = new URLSearchParams();
            for (const key in data) {
                if (data.hasOwnProperty(key)) {
                    params.append(key, data[key]);
                }
            }
            return params;
        }

        async function fetchAppsScript(action, payload = {}) {
            // Only show full screen loader for non-background tasks
            if(action !== 'toggleLike' && action !== 'addComment') {
                adminState.loading = true;
                render(adminState.isLoggedIn ? AdminDashboard : AdminLogin); 
            }

            const dataToSend = { action, ...payload };
            const formBody = jsonToUrlParams(dataToSend);
            
            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    // IMPORTANT: No Content-Type header. Body is URLSearchParams.
                    body: formBody 
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const responseText = await response.text();
                const result = responseText ? JSON.parse(responseText) : {};
                
                adminState.loading = false;
                // Re-render if it was a blocking load
                if(action !== 'toggleLike' && action !== 'addComment') {
                   // Only re-render if we are still on the same tab/state
                   // This prevents UI jumps during background updates
                }
                return result;

            } catch (error) {
                console.error('API Fetch Error:', error);
                adminState.loading = false;
                return { result: 'error', message: 'Network error. Check console.' };
            }
        }

        // --- AUTHENTICATION ---

        function checkAuth() {
            const storedState = localStorage.getItem('adminState');
            if (storedState) {
                const state = JSON.parse(storedState);
                if (state.isLoggedIn && state.assignedCourse) {
                    adminState = { ...adminState, ...state, isLoggedIn: true };
                    loadInitialData();
                    return;
                }
            }
            adminState.isLoggedIn = false;
            render(AdminLogin);
        }

        function saveAdminState() {
            localStorage.setItem('adminState', JSON.stringify({
                isLoggedIn: adminState.isLoggedIn,
                username: adminState.username,
                assignedCourse: adminState.assignedCourse
            }));
        }

        async function handleAdminLogin(e) {
            e.preventDefault();
            const form = e.target;
            const username = form.username.value.trim();
            const password = form.password.value;

            showMessage('Logging in...');

            const result = await fetchAppsScript('adminLogin', { username, password });

            if (result && result.result === 'success') {
                adminState.isLoggedIn = true;
                adminState.username = username;
                adminState.assignedCourse = result.assignedCourse;
                saveAdminState();
                showMessage('Login successful! Welcome.', false);
                loadInitialData();
            } else {
                adminState.isLoggedIn = false;
                const errMsg = result ? result.message : 'Unknown login error';
                showMessage(errMsg || 'Login failed. Check credentials.', true);
            }
        }

        function handleLogout() {
            localStorage.removeItem('adminState');
            adminState = { 
                isLoggedIn: false, 
                username: '', 
                assignedCourse: '', 
                activeTab: 'dashboard', 
                students: [], announcements: [], assignments: [], attendance: []
            };
            render(AdminLogin);
        }

        function bindLoginEvents() {
            const loginForm = document.getElementById('adminLoginForm');
            if (loginForm) {
                loginForm.addEventListener('submit', handleAdminLogin);
            }
        }

        // --- DATA LOADING & DASHBOARD MANAGEMENT ---

        async function loadInitialData() {
            if (!adminState.isLoggedIn) return;
            
            // Initial Load Spinner
            if(adminState.students.length === 0) {
                adminState.loading = true;
                render(AdminDashboard);
            }

            const course = adminState.assignedCourse;

            try {
                // Fetch students, announcements, and assignments concurrently
                const [studentsResult, announcementsResult, assignmentsResult] = await Promise.all([
                    fetchAppsScript('getStudentsByCourse', { course }),
                    // Send currentUser so backend knows 'likedByMe' status
                    fetchAppsScript('getAnnouncementsByCourse', { course, currentUser: adminState.username }),
                    fetchAppsScript('getAssignmentsByCourse', { course })
                ]);

                adminState.students = studentsResult && studentsResult.result === 'success' ? studentsResult.data : [];
                adminState.announcements = announcementsResult && announcementsResult.result === 'success' ? announcementsResult.data : [];
                adminState.assignments = assignmentsResult && assignmentsResult.result === 'success' ? assignmentsResult.data : [];
            } catch (err) {
                console.error("Error loading dashboard data", err);
            }
            
            adminState.loading = false;
            render(AdminDashboard);
        }

        function changeTab(tabName) {
            adminState.activeTab = tabName;
            adminState.message = null; 
            render(AdminDashboard);
        }

        // --- CRUD OPERATIONS ---

        async function handleAddAnnouncement(e) {
            e.preventDefault();
            const form = e.target;
            const title = form.title.value;
            const content = form.content.value;
            const course = adminState.assignedCourse;
            
            showMessage('Adding Announcement...');
            
            const result = await fetchAppsScript('addAnnouncement', { course, title, content });

            if (result.result === 'success') {
                showMessage('Announcement posted successfully!', false);
                form.reset();
                loadInitialData(); 
            } else {
                showMessage(result.message || 'Failed.', true);
            }
        }

        async function handleAddAssignment(e) {
            e.preventDefault();
            const form = e.target;
            const title = form.title.value;
            const description = form.description.value;
            const dueDate = form.dueDate.value;
            const course = adminState.assignedCourse;

            showMessage('Adding Assignment...');
            
            const result = await fetchAppsScript('addAssignment', { course, title, description, dueDate });

            if (result.result === 'success') {
                showMessage('Assignment added successfully!', false);
                form.reset();
                loadInitialData(); 
            } else {
                showMessage(result.message || 'Failed.', true);
            }
        }

        async function handleRemoveStudent(admNo, course) {
            if(!confirm(`Are you sure you want to remove student ${admNo}?`)) return;
            
            showMessage(`Removing student ${admNo}...`);
            
            const result = await fetchAppsScript('removeStudent', { admNo, course });

            if (result.result === 'success') {
                showMessage(`Student ${admNo} removed.`, false);
                adminState.students = adminState.students.filter(s => s.admNo !== admNo);
                render(AdminDashboard); // Re-render to update list
            } else {
                showMessage(result.message || 'Failed.', true);
            }
        }

        // --- ATTENDANCE LOGIC ---

        function filterAttendanceList(query) {
            const listContainer = document.getElementById('attendanceListContainer');
            const lowerQuery = query.toLowerCase();
            
            const filteredStudents = adminState.students.filter(s => 
                s.firstName.toLowerCase().includes(lowerQuery) || 
                s.lastName.toLowerCase().includes(lowerQuery) || 
                String(s.admNo).toLowerCase().includes(lowerQuery)
            );

            if (filteredStudents.length === 0) {
                listContainer.innerHTML = `<div class="p-8 text-center text-gray-500">No students found matching "${query}"</div>`;
                return;
            }

            listContainer.innerHTML = filteredStudents.map(student => `
                <div class="flex items-center justify-between p-4 border-b border-gray-100 hover:bg-gray-50 transition">
                    <div class="flex items-center space-x-4">
                        <div class="bg-indigo-100 text-indigo-700 w-10 h-10 rounded-full flex items-center justify-center font-bold text-xs">
                            ${student.admNo}
                        </div>
                        <div>
                            <p class="font-semibold text-gray-800">${student.firstName} ${student.lastName}</p>
                            <p class="text-xs text-gray-500">${student.email}</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-2">
                        <select id="status-${student.admNo}" class="text-sm border-gray-300 rounded-md shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 p-2 border">
                            <option value="Present">Present</option>
                            <option value="Absent">Absent</option>
                            <option value="Late">Late</option>
                            <option value="Excused">Excused</option>
                        </select>
                        <button onclick="handleQuickAttendance('${student.admNo}')" 
                                class="bg-indigo-600 hover:bg-indigo-700 text-white p-2 rounded-md shadow transition flex items-center">
                            <span data-lucide="check" class="w-4 h-4"></span>
                            <span class="ml-2 text-xs font-bold uppercase hidden md:inline">Save</span>
                        </button>
                    </div>
                </div>
            `).join('');
            
            lucide.createIcons(); 
        }

        async function handleQuickAttendance(admNo) {
            const date = document.getElementById('attendanceDate').value;
            const statusSelect = document.getElementById(`status-${admNo}`);
            const status = statusSelect.value;
            const course = adminState.assignedCourse;

            const btn = statusSelect.nextElementSibling;
            const originalContent = btn.innerHTML;
            btn.innerHTML = `<span class="animate-spin w-4 h-4 border-2 border-white border-t-transparent rounded-full"></span>`;
            btn.disabled = true;

            const result = await fetchAppsScript('recordAttendance', { admNo, status, date, course });

            if (result.result === 'success') {
                btn.innerHTML = `<span data-lucide="check-circle" class="w-4 h-4"></span>`;
                btn.classList.replace('bg-indigo-600', 'bg-green-500');
                btn.classList.replace('hover:bg-indigo-700', 'hover:bg-green-600');
                
                const toast = document.getElementById('toastMsg');
                toast.innerText = `Recorded: ${admNo} is ${status}`;
                toast.classList.remove('opacity-0', 'translate-y-4');
                setTimeout(() => {
                    toast.classList.add('opacity-0', 'translate-y-4');
                    btn.innerHTML = originalContent;
                    btn.classList.replace('bg-green-500', 'bg-indigo-600');
                    btn.classList.replace('hover:bg-green-600', 'hover:bg-indigo-700');
                    btn.disabled = false;
                    lucide.createIcons();
                }, 2000);
            } else {
                alert("Failed to record attendance: " + result.message);
                btn.innerHTML = originalContent;
                btn.disabled = false;
                lucide.createIcons();
            }
        }

        // --- SOCIAL INTERACTIONS (REAL TIME) ---

        async function toggleLike(annId, btnElement) {
            const icon = btnElement.querySelector('.like-icon');
            const countSpan = btnElement.querySelector('.like-count');
            let currentCount = parseInt(countSpan.innerText);
            
            // Check current state based on visual class
            const isLiked = icon.classList.contains('fill-current') && icon.classList.contains('text-red-500');

            // Optimistic UI Update
            if (isLiked) {
                // Unlike
                icon.classList.remove('fill-current', 'text-red-500');
                icon.classList.add('text-gray-500');
                countSpan.innerText = currentCount - 1;
            } else {
                // Like
                icon.classList.add('fill-current', 'text-red-500');
                icon.classList.remove('text-gray-500');
                countSpan.innerText = currentCount + 1;
            }

            // Silent API call
            try {
                await fetchAppsScript('toggleLike', { 
                    announcementId: annId, 
                    user: adminState.username 
                });
            } catch (e) {
                console.error("Like failed", e);
                // Ideally revert UI here, but kept simple
            }
        }

        async function postComment(annId) {
            const input = document.getElementById(`comment-input-${annId}`);
            const text = input.value.trim();
            if(!text) return;

            // Optimistic UI Update
            const list = document.getElementById(`comment-list-${annId}`);
            
            // Remove "No comments" text if present
            const emptyMsg = list.querySelector('.empty-msg');
            if(emptyMsg) emptyMsg.remove();

            const tempComment = `
                <div class="bg-white p-2 rounded border border-gray-100 opacity-70">
                    <div class="flex justify-between items-baseline">
                        <span class="text-xs font-bold text-gray-700">Me</span>
                        <span class="text-[10px] text-gray-400">Just now</span>
                    </div>
                    <p class="text-xs text-gray-600 mt-1">${text}</p>
                </div>
            `;
            list.insertAdjacentHTML('beforeend', tempComment);
            input.value = '';

            try {
                await fetchAppsScript('addComment', { 
                    announcementId: annId, 
                    user: adminState.username, // Post as Admin
                    comment: text 
                });
                // In a real app we might refetch to confirm ID/Time
            } catch(e) {
                alert("Failed to post comment");
            }
        }


        // --- UI COMPONENTS ---

        function AdminLogin() {
            const statusMessage = adminState.message || '';
            return `
                <div class="min-h-screen flex items-center justify-center p-4">
                    <div class="w-full max-w-md bg-white p-8 rounded-xl shadow-2xl border border-gray-100">
                        <div class="text-center mb-8">
                            <h2 class="text-3xl font-extrabold text-gray-900">Admin Login</h2>
                            <p class="mt-2 text-sm text-gray-600">School Management System</p>
                        </div>
                        <form id="adminLoginForm" class="space-y-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Username</label>
                                <input type="text" name="username" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                                <input type="password" name="password" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500">
                            </div>
                            <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-emerald-600 hover:bg-emerald-700 transition">
                                <span data-lucide="log-in" class="w-5 h-5 mr-2"></span> Log In
                            </button>
                        </form>
                        ${statusMessage ? `<p class="mt-4 text-center text-sm ${adminState.error ? 'text-red-600' : 'text-emerald-600'}">${statusMessage}</p>` : ''}
                    </div>
                </div>
            `;
        }

        function AdminDashboard() {
            const tabs = [
                { id: 'dashboard', name: 'Dashboard', icon: 'layout-dashboard' },
                { id: 'students', name: 'Students', icon: 'users' },
                { id: 'announcements', name: 'Announcements', icon: 'megaphone' },
                { id: 'assignments', name: 'Assignments', icon: 'clipboard-list' },
                { id: 'attendance', name: 'Attendance', icon: 'calendar-check' },
            ];

            return `
                <div class="min-h-screen flex">
                    <!-- Sidebar -->
                    <div class="sidebar w-64 bg-gray-800 text-white flex flex-col p-4 shadow-2xl hidden md:flex">
                        <div class="flex-shrink-0 text-xl font-bold py-4 border-b border-gray-700 mb-6">
                            <span data-lucide="graduation-cap" class="inline-block w-6 h-6 mr-2"></span> Admin Panel
                        </div>
                        
                        <div class="text-sm p-3 bg-gray-700 rounded-lg mb-6">
                            <p class="font-semibold">${adminState.username}</p>
                            <p class="text-xs text-gray-300">Course: ${adminState.assignedCourse}</p>
                        </div>

                        <nav class="flex-grow">
                            ${tabs.map(tab => `
                                <div class="nav-item ${adminState.activeTab === tab.id ? 'active' : 'text-gray-300'}" data-tab="${tab.id}">
                                    <span data-lucide="${tab.icon}" class="w-5 h-5 mr-3"></span>
                                    ${tab.name}
                                </div>
                            `).join('')}
                        </nav>

                        <div class="mt-auto pt-4 border-t border-gray-700">
                            <button id="logoutBtn" class="w-full flex items-center justify-center p-3 text-red-400 hover:bg-gray-700 rounded-lg transition duration-150">
                                <span data-lucide="log-out" class="w-5 h-5 mr-2"></span> Logout
                            </button>
                        </div>
                    </div>

                    <!-- Main Content -->
                    <main class="flex-grow p-4 md:p-8 overflow-y-auto h-screen relative">
                        <!-- Mobile Header -->
                        <div class="md:hidden flex justify-between items-center mb-6">
                            <h1 class="text-xl font-bold">Admin Panel</h1>
                            <button onclick="handleLogout()" class="text-red-500"><span data-lucide="log-out"></span></button>
                        </div>

                        <!-- Mobile Tab Bar (Simplified) -->
                        <div class="md:hidden flex overflow-x-auto space-x-2 mb-4 pb-2">
                             ${tabs.map(tab => `
                                <button class="px-3 py-2 rounded-full text-xs font-bold whitespace-nowrap ${adminState.activeTab === tab.id ? 'bg-emerald-600 text-white' : 'bg-white text-gray-600'}" 
                                    onclick="changeTab('${tab.id}')">
                                    ${tab.name}
                                </button>
                            `).join('')}
                        </div>

                        <h1 class="text-3xl font-bold text-gray-800 mb-6 hidden md:block">
                            ${tabs.find(t => t.id === adminState.activeTab).name} Management
                        </h1>

                        <!-- Toast Notification Container -->
                        <div id="toastMsg" class="fixed bottom-4 right-4 bg-gray-800 text-white px-6 py-3 rounded-lg shadow-lg transform transition-all duration-300 opacity-0 translate-y-4 z-50">
                            Notification
                        </div>

                        <div class="bg-white p-6 rounded-xl shadow-lg min-h-[500px]">
                            ${adminState.loading ? LoadingSpinner() : renderActiveTabContent()}
                        </div>
                    </main>
                </div>
            `;
        }
        
        function LoadingSpinner() {
            return `
                <div class="flex flex-col items-center justify-center py-20">
                    <svg class="animate-spin -ml-1 mr-3 h-10 w-10 text-emerald-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <p class="mt-4 text-gray-600">Loading data...</p>
                </div>
            `;
        }

        function renderActiveTabContent() {
            switch (adminState.activeTab) {
                case 'dashboard': return DashboardTab();
                case 'students': return StudentList();
                case 'announcements': return AnnouncementsTab();
                case 'assignments': return AssignmentsTab();
                case 'attendance': return AttendanceTab();
                default: return `<p>Select a tab.</p>`;
            }
        }

        // --- TAB CONTENTS ---

        function DashboardTab() {
            const studentCount = adminState.students.length;
            const assignmentCount = adminState.assignments.length;
            const announcementCount = adminState.announcements.length;

            return `
                <h2 class="text-2xl font-semibold mb-6 text-gray-700">Course: ${adminState.assignedCourse}</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="bg-blue-50 p-6 rounded-xl shadow-md border-b-4 border-blue-500 flex justify-between items-center">
                        <div><p class="text-sm font-medium text-blue-600">Total Students</p><p class="text-4xl font-extrabold text-blue-900 mt-1">${studentCount}</p></div>
                        <span data-lucide="users" class="w-10 h-10 text-blue-400"></span>
                    </div>
                    <div class="bg-yellow-50 p-6 rounded-xl shadow-md border-b-4 border-yellow-500 flex justify-between items-center">
                        <div><p class="text-sm font-medium text-yellow-600">Active Assignments</p><p class="text-4xl font-extrabold text-yellow-900 mt-1">${assignmentCount}</p></div>
                        <span data-lucide="clipboard-list" class="w-10 h-10 text-yellow-400"></span>
                    </div>
                    <div class="bg-green-50 p-6 rounded-xl shadow-md border-b-4 border-green-500 flex justify-between items-center">
                        <div><p class="text-sm font-medium text-green-600">Total Announcements</p><p class="text-4xl font-extrabold text-green-900 mt-1">${announcementCount}</p></div>
                        <span data-lucide="megaphone" class="w-10 h-10 text-green-400"></span>
                    </div>
                </div>
            `;
        }

        function StudentList() {
            return `
                <h2 class="text-2xl font-semibold mb-4 text-gray-700">All Students (${adminState.students.length})</h2>
                ${adminState.students.length === 0 ? `<p>No students found.</p>` : `
                    <div class="data-container">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50 sticky top-0">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Adm. No</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Name</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Action</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                ${adminState.students.map(s => `
                                    <tr>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${s.admNo}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${s.firstName} ${s.lastName}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm">
                                            <button onclick="handleRemoveStudent('${s.admNo}', '${adminState.assignedCourse}')" class="text-red-600 hover:text-red-900">Remove</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>`}
            `;
        }

        function AnnouncementsTab() {
            return `
                <div class="grid md:grid-cols-2 gap-8">
                    <div>
                        <h2 class="text-2xl font-semibold mb-4 text-gray-700">Post Announcement</h2>
                        <form id="announcementForm" class="space-y-4 bg-gray-50 p-6 rounded-lg border">
                            <input type="text" name="title" required placeholder="Title" class="w-full px-3 py-2 border rounded-lg">
                            <textarea name="content" rows="4" required placeholder="Message" class="w-full px-3 py-2 border rounded-lg"></textarea>
                            <button type="submit" class="action-btn bg-emerald-600 text-white w-full">Post</button>
                        </form>
                    </div>
                    <div>
                        <h2 class="text-2xl font-semibold mb-4 text-gray-700">Recent Updates</h2>
                        <div class="space-y-6 data-container max-h-[600px] overflow-y-auto pb-4">
                            ${adminState.announcements.length === 0 ? 
                                `<p class="text-gray-500 p-4">No announcements posted yet.</p>` : 
                                adminState.announcements.map((a, index) => {
                                    // Data from server
                                    const likes = a.likes || 0;
                                    const comments = a.comments || [];
                                    const likedByMe = a.likedByMe || false;
                                    const annId = a.id;
                                    
                                    return `
                                    <div class="border rounded-xl bg-white shadow-sm overflow-hidden">
                                        <div class="p-5">
                                            <div class="flex justify-between items-start">
                                                <h3 class="font-bold text-lg text-gray-900">${a.title}</h3>
                                                <span class="text-xs text-gray-400 bg-gray-100 px-2 py-1 rounded-full">${a.date}</span>
                                            </div>
                                            <p class="text-gray-600 mt-2 text-sm leading-relaxed">${a.content}</p>
                                        </div>
                                        
                                        <!-- Interactive Footer -->
                                        <div class="bg-gray-50 px-5 py-3 border-t border-gray-100">
                                            <div class="flex items-center space-x-6">
                                                <!-- Like Button -->
                                                <button onclick="toggleLike('${annId}', this)" class="flex items-center space-x-2 group transition focus:outline-none">
                                                    <span data-lucide="heart" class="like-icon w-5 h-5 ${likedByMe ? 'fill-current text-red-500' : 'text-gray-500'}"></span>
                                                    <span class="like-count text-sm font-medium group-hover:scale-110 transition-transform">${likes}</span>
                                                </button>
                                                
                                                <!-- Comment Toggle -->
                                                <button class="flex items-center space-x-2 text-gray-500 hover:text-blue-500 transition"
                                                    onclick="document.getElementById('comments-${index}').classList.toggle('hidden')">
                                                    <span data-lucide="message-circle" class="w-5 h-5"></span>
                                                    <span class="text-sm font-medium">${comments.length}</span>
                                                </button>
                                            </div>

                                            <!-- Comments Section (Collapsible) -->
                                            <div id="comments-${index}" class="hidden mt-4 pt-4 border-t border-gray-200">
                                                <div class="space-y-3 mb-4 max-h-40 overflow-y-auto" id="comment-list-${annId}">
                                                    ${comments.length === 0 ? 
                                                        `<p class="empty-msg text-xs text-gray-400 italic">No comments yet.</p>` :
                                                        comments.map(c => `
                                                            <div class="bg-white p-2 rounded border border-gray-100">
                                                                <div class="flex justify-between items-baseline">
                                                                    <span class="text-xs font-bold text-gray-700">${c.user}</span>
                                                                    <span class="text-[10px] text-gray-400">${c.time}</span>
                                                                </div>
                                                                <p class="text-xs text-gray-600 mt-1">${c.text}</p>
                                                            </div>
                                                        `).join('')
                                                    }
                                                </div>
                                                <div class="flex space-x-2">
                                                    <input type="text" id="comment-input-${annId}" 
                                                        placeholder="Write a comment..." 
                                                        class="flex-1 text-sm px-3 py-2 border rounded-full focus:outline-none focus:border-emerald-500"
                                                        onkeydown="if(event.key === 'Enter') postComment('${annId}')">
                                                    <button onclick="postComment('${annId}')" 
                                                        class="bg-emerald-500 text-white p-2 rounded-full hover:bg-emerald-600 transition">
                                                        <span data-lucide="send" class="w-4 h-4"></span>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    `;
                                }).join('')
                            }
                        </div>
                    </div>
                </div>
            `;
        }

        function AssignmentsTab() {
            return `
                <div class="grid md:grid-cols-2 gap-8">
                    <div>
                        <h2 class="text-2xl font-semibold mb-4 text-gray-700">New Assignment</h2>
                        <form id="assignmentForm" class="space-y-4 bg-gray-50 p-6 rounded-lg border">
                            <input type="text" name="title" required placeholder="Title" class="w-full px-3 py-2 border rounded-lg">
                            <textarea name="description" rows="4" required placeholder="Details" class="w-full px-3 py-2 border rounded-lg"></textarea>
                            <input type="date" name="dueDate" required class="w-full px-3 py-2 border rounded-lg">
                            <button type="submit" class="action-btn bg-blue-600 text-white w-full">Create</button>
                        </form>
                    </div>
                    <div>
                        <h2 class="text-2xl font-semibold mb-4 text-gray-700">Active</h2>
                        <div class="space-y-4 data-container max-h-96 overflow-y-auto">
                             ${adminState.assignments.map(a => `
                                <div class="p-4 border rounded-lg bg-white shadow-sm">
                                    <p class="font-bold">${a.title}</p>
                                    <p class="text-sm text-gray-600">${a.description}</p>
                                    <p class="text-xs mt-1">Due: ${a.dueDate}</p>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        function AttendanceTab() {
            // Updated Tab with Search capabilities
            return `
                <div class="max-w-4xl mx-auto">
                    <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                        <h2 class="text-2xl font-semibold text-gray-700">Mark Attendance</h2>
                        <div class="flex items-center space-x-2">
                            <label class="text-sm font-bold text-gray-600">Date:</label>
                            <input type="date" id="attendanceDate" value="${new Date().toISOString().slice(0, 10)}" 
                                class="px-3 py-2 border rounded-lg focus:ring-emerald-500 focus:border-emerald-500">
                        </div>
                    </div>

                    <!-- Search Bar -->
                    <div class="relative mb-6">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <span data-lucide="search" class="text-gray-400 w-5 h-5"></span>
                        </div>
                        <input type="text" id="studentSearchInput" placeholder="Search by Student Name or Admission Number..." 
                            class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-lg transition"
                            autocomplete="off">
                    </div>

                    <!-- Results List -->
                    <div class="bg-white rounded-lg shadow border border-gray-200 overflow-hidden">
                        <div class="bg-gray-50 px-4 py-2 border-b border-gray-200 flex justify-between items-center">
                            <span class="text-xs font-bold text-gray-500 uppercase tracking-wider">Student Details</span>
                            <span class="text-xs font-bold text-gray-500 uppercase tracking-wider">Mark Status</span>
                        </div>
                        
                        <div id="attendanceListContainer" class="divide-y divide-gray-100 max-h-[500px] overflow-y-auto">
                            <!-- List items injected here via JS -->
                            <div class="p-8 text-center text-gray-500 flex flex-col items-center">
                                <span data-lucide="search" class="w-12 h-12 text-gray-300 mb-2"></span>
                                <p>Start typing a name or admission number above to find students.</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // --- BINDING EVENTS ---

        function bindDashboardEvents() {
            // Tab switching
            document.querySelectorAll('.nav-item').forEach(item => {
                item.onclick = () => changeTab(item.getAttribute('data-tab'));
            });

            // Logout
            const logoutBtn = document.getElementById('logoutBtn');
            if(logoutBtn) logoutBtn.onclick = handleLogout;
            
            // Basic Forms
            const announcementForm = document.getElementById('announcementForm');
            if(announcementForm) announcementForm.onsubmit = handleAddAnnouncement;
            
            const assignmentForm = document.getElementById('assignmentForm');
            if(assignmentForm) assignmentForm.onsubmit = handleAddAssignment;

            // --- SEARCH EVENT BINDING ---
            const searchInput = document.getElementById('studentSearchInput');
            if (searchInput) {
                searchInput.addEventListener('input', (e) => {
                    const query = e.target.value.trim();
                    if (query.length > 0) {
                        filterAttendanceList(query);
                    } else {
                        document.getElementById('attendanceListContainer').innerHTML = `
                             <div class="p-8 text-center text-gray-500 flex flex-col items-center">
                                <span data-lucide="search" class="w-12 h-12 text-gray-300 mb-2"></span>
                                <p>Start typing a name or admission number above to find students.</p>
                            </div>
                        `;
                        lucide.createIcons();
                    }
                });
                // Focus the input automatically if we just switched to this tab
                searchInput.focus();
            }
        }

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', checkAuth);

    </script>
</body>
</html>
