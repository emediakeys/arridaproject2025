<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Admission Portal</title>

    <link rel="icon" type="image/png" sizes="32x32" href="icon.jpg">
    <link rel="icon" type="image/png" sizes="16x16" href="icon.jpg">
    <link rel="apple-touch-icon" href="icon.jpg">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f7f9fc; }
        .form-group label { transition: color 0.2s; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5); }
        .btn-submit:disabled { @apply bg-gray-400 cursor-not-allowed; }
        .modal-overlay { background-color: rgba(0, 0, 0, 0.6); backdrop-filter: blur(2px); z-index: 50; transition: opacity 0.3s ease; }
        .modal-content { animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { opacity: 0; transform: translate(-50%, -60%); } to { opacity: 1; transform: translate(-50%, -50%); } }
        @media print { .print-hidden { display: none !important; } }
    </style>
</head>
<body class="bg-gray-100 p-4 sm:p-8">

<div class="max-w-3xl mx-auto bg-white p-6 sm:p-8 rounded-xl shadow-2xl">
    <header class="text-center mb-8 print-hidden">
        <h1 class="text-3xl sm:text-4xl font-extrabold text-blue-800">Student Application Form</h1>
        <p class="text-gray-500 mt-2">Please fill in all details carefully to complete your admission.</p>
    </header>

    <form id="admissionForm">
        
        <fieldset class="border border-gray-200 p-6 rounded-lg mb-8 print-hidden">
            <legend class="text-xl font-semibold text-blue-700 px-3 -ml-3">1. Biodata & Passport</legend>
            <div class="form-group mb-4">
                <label for="passport" class="block text-sm font-medium text-gray-700 mb-2">Upload Passport Photograph</label>
                <input type="file" id="passport" accept="image/*" required class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                <div id="preview-container" class="mt-4"></div>
                <input type="hidden" id="passportBase64">
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="col"><label for="firstName" class="block text-sm font-medium text-gray-700">First Name</label><input type="text" id="firstName" name="firstName" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"></div>
                <div class="col"><label for="lastName" class="block text-sm font-medium text-gray-700">Last Name</label><input type="text" id="lastName" name="lastName" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"></div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                <div class="col"><label for="dob" class="block text-sm font-medium text-gray-700">Date of Birth</label><input type="date" id="dob" name="dob" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"></div>
                <div class="col"><label for="gender" class="block text-sm font-medium text-gray-700">Gender</label><select id="gender" name="gender" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"><option value="">Select...</option><option value="Male">Male</option><option value="Female">Female</option></select></div>
            </div>
        </fieldset>
        
        <fieldset class="border border-gray-200 p-6 rounded-lg mb-8 print-hidden">
            <legend class="text-xl font-semibold text-blue-700 px-3 -ml-3">2. Contact & Login Details</legend>
            <div class="form-group mb-4"><label for="address" class="block text-sm font-medium text-gray-700">Home Address</label><textarea id="address" name="address" rows="2" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"></textarea></div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="col"><label for="email" class="block text-sm font-medium text-gray-700">Email Address</label><input type="email" id="email" name="email" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"></div>
                <div class="col"><label for="password" class="block text-sm font-medium text-gray-700">Create Password</label><input type="password" id="password" name="password" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"><small class="block text-xs text-gray-500 mt-1">You will use this to login to the dashboard.</small></div>
            </div>
        </fieldset>
        
        <fieldset class="border border-gray-200 p-6 rounded-lg mb-8 print-hidden">
            <legend class="text-xl font-semibold text-blue-700 px-3 -ml-3">3. Background & Documents</legend>
            <div class="form-group mb-4"><label for="course" class="block text-sm font-medium text-gray-700">Course Applying For</label><select name="course" id="course" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"><option value="">-- Select Course --</option><option value="Community Health Extension Workers">Community Health Extension Workers</option><option value="Public Health">Public Health</option><option value="Pharmacy Technician">Pharmacy Technician</option><option value="Medical Laboratory Technician">Medical Laboratory Technician</option></select></div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div class="col">
                    <label for="birthCert" class="block text-sm font-medium text-gray-700">Upload Birth Certificate</label>
                    <input type="file" id="birthCert" accept=".pdf, image/*" required class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-green-50 file:text-green-700 hover:file:bg-green-100">
                    <input type="hidden" id="birthCertBase64">
                </div>
                <div class="col">
                    <label for="olevel" class="block text-sm font-medium text-gray-700">Upload O'Level Result</label>
                    <input type="file" id="olevel" accept=".pdf, image/*" required class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-green-50 file:text-green-700 hover:file:bg-green-100">
                    <input type="hidden" id="olevelBase64">
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div class="col"><label for="nokName" class="block text-sm font-medium text-gray-700">Next of Kin Name</label><input type="text" id="nokName" name="nokName" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"></div>
                <div class="col"><label for="nokPhone" class="block text-sm font-medium text-gray-700">Next of Kin Phone</label><input type="tel" id="nokPhone" name="nokPhone" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"></div>
            </div>
            <div class="form-group mb-4"><label for="sponsor" class="block text-sm font-medium text-gray-700">Sponsor Name</label><input type="text" id="sponsor" name="sponsor" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"></div>
            <div class="form-group"><label for="prevSchool" class="block text-sm font-medium text-gray-700">Previous School Attended</label><input type="text" id="prevSchool" name="prevSchool" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"></div>
        </fieldset>
        
        <div class="payment-section text-center bg-yellow-50 p-6 rounded-lg border border-yellow-200 print-hidden">
            <p class="text-lg font-bold text-gray-800 mb-4">Application Fee: <strong class="text-green-600">₦7,500</strong></p>
            <button type="button" id="payBtn" class="btn-pay w-full sm:w-auto bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg transition duration-150 ease-in-out shadow-md">Pay ₦7,500 Now</button>
            <p id="payment-status" class="mt-4 text-green-700 font-bold hidden"><svg class="inline w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>Payment Successful!</p>
            <hr class="my-6 border-gray-300">
            <button type="submit" id="submitBtn" class="btn-submit w-full bg-blue-600 hover:bg-blue-700 text-white font-extrabold py-4 px-8 rounded-lg text-lg transition duration-150 ease-in-out shadow-xl" disabled>Submit Application</button>
        </div>
    </form>
    <div id="loading" class="text-center mt-6 p-4 bg-blue-100 text-blue-800 rounded-md font-semibold hidden print-hidden">Processing Application...</div>
</div>

<div id="customPopup" class="modal-overlay fixed inset-0 hidden items-center justify-center p-4">
    <div class="modal-content bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full relative">
        <div id="popupIcon" class="flex justify-center mb-4"></div>
        <h3 id="popupTitle" class="text-xl font-bold text-gray-900 mb-2 text-center"></h3>
        <p id="popupMessage" class="text-gray-600 mb-6 text-center"></p>
        <div id="popupActions" class="flex justify-center gap-4"></div>
    </div>
</div>

<script src="https://js.paystack.co/v1/inline.js"></script>
<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyMEpK3kKSrQR99hvVBA0fvs-_eWGKHzfQutXHy7X369_ELy0t8BpI-2mrSYnWKVkNX4Q/exec"; 
    const PAYSTACK_PUBLIC_KEY = "pk_test_29f23a0e0bde6c074ae9efb019002a8d95e721b4"; 
    const APPLICATION_FEE_NAIRA = 7500;
    const APPLICATION_FEE_KOBO = APPLICATION_FEE_NAIRA * 100;

    const popupElement = document.getElementById('customPopup');
    const popupTitle = document.getElementById('popupTitle');
    const popupMessage = document.getElementById('popupMessage');
    const popupIconContainer = document.getElementById('popupIcon');
    const popupActionsContainer = document.getElementById('popupActions');
    const mainContainer = document.querySelector('.max-w-3xl.mx-auto');
    let lastSubmittedData = null;

    const errorIcon = `<svg class="w-12 h-12 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;
    const successIcon = `<svg class="w-12 h-12 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;

    function restoreFormContent(encodedContent) {
        mainContainer.innerHTML = decodeURIComponent(encodedContent);
        window.location.reload();
    }

    function showCustomPopup(message, type = 'error', title = 'Notification', actions = []) {
        popupTitle.textContent = title;
        popupMessage.textContent = message;
        popupIconContainer.innerHTML = type === 'success' ? successIcon : errorIcon;
        popupActionsContainer.innerHTML = '';
        if (actions.length === 0) actions.push({ text: 'OK', handler: closeCustomPopup, isPrimary: true });
        actions.forEach(action => {
            const button = document.createElement('button');
            button.textContent = action.text;
            const baseClasses = 'px-5 py-2 font-medium rounded-lg transition duration-150 ease-in-out focus:outline-none focus:ring-2 focus:ring-offset-2';
            button.className = action.isPrimary ? `${baseClasses} bg-blue-600 text-white hover:bg-blue-700` : `${baseClasses} bg-gray-200 text-gray-800 hover:bg-gray-300`;
            if (actions.length > 1) button.classList.add('mx-1');
            button.addEventListener('click', action.handler);
            popupActionsContainer.appendChild(button);
        });
        popupElement.classList.remove('hidden');
        popupElement.classList.add('flex');
    }
    function closeCustomPopup() {
        popupElement.classList.add('hidden');
        popupElement.classList.remove('flex');
        popupActionsContainer.innerHTML = '';
    }

    function printSummary(admNo) {
        if (!lastSubmittedData) return;
        closeCustomPopup();
        const data = lastSubmittedData;
        const today = new Date().toLocaleDateString();
        const originalContent = mainContainer.innerHTML; 
        const printContent = `<div class="p-6"><div class="text-center mb-8 border-b pb-4"><h2 class="text-3xl font-extrabold text-blue-800">Student Application Summary</h2><p class="text-lg text-gray-500 mt-2">Admission Number: <strong class="text-blue-600">${admNo}</strong></p><p class="text-sm text-gray-500">Date: ${today}</p></div><div class="flex justify-between items-start mb-6"><div class="space-y-1 text-sm"><p class="font-bold text-gray-800">${data.firstName} ${data.lastName}</p><p class="text-gray-600">Email: ${data.email}</p><p class="text-gray-600">DOB: ${data.dob} (${data.gender})</p></div><img src="${data.passportBase64}" alt="Passport" class="w-24 h-24 object-cover border-4 border-blue-200 shadow-lg rounded-lg"></div><div class="space-y-4"><h3 class="text-xl font-semibold text-blue-700 border-b pb-1">Application Details</h3><p class="text-sm"><strong>Course:</strong> ${data.course}</p><p class="text-sm"><strong>Address:</strong> ${data.address}</p><p class="text-sm text-green-700 font-bold">Fee Paid: ₦${APPLICATION_FEE_NAIRA}.00 (Ref: ${data.paymentRef})</p></div><div class="text-center mt-10 p-4 bg-gray-50 border border-gray-200 rounded-lg text-sm text-gray-600 print-hidden"><button onclick="window.location.reload()" class="mt-4 px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">Start New Application</button></div></div>`;
        mainContainer.innerHTML = printContent;
        window.print();
    }

    // --- SMART COMPRESSION LOGIC ---
    function compressImage(file, maxWidth, quality, callback) {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = event => {
            const img = new Image();
            img.src = event.target.result;
            img.onload = () => {
                const elem = document.createElement('canvas');
                let width = img.width;
                let height = img.height;
                if (width > maxWidth) { height *= maxWidth / width; width = maxWidth; }
                elem.width = width;
                elem.height = height;
                const ctx = elem.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);
                // Compress to JPEG to reduce size significantly
                const dataUrl = elem.toDataURL('image/jpeg', quality);
                callback(dataUrl);
            };
        };
    }

    function handleFileUpload(input, hiddenField, previewEl = null) {
        input.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if(!file) return;
            
            // If image, compress it. If PDF, read as-is (but beware size limits)
            if(file.type.startsWith('image/')) {
                // Compress to 800px width, 0.6 quality (High compression)
                compressImage(file, 800, 0.6, (base64) => {
                    hiddenField.value = base64;
                    if(previewEl) previewEl.innerHTML = `<img src="${base64}" class="max-w-[150px] mt-2 rounded-md border-4 border-blue-200 shadow-lg">`;
                });
            } else {
                // For PDFs, just read them (User must ensure they are small < 2MB)
                const reader = new FileReader();
                reader.onload = (e) => hiddenField.value = e.target.result;
                reader.readAsDataURL(file);
            }
        });
    }

    document.addEventListener('DOMContentLoaded', function() {
        const payBtn = document.getElementById('payBtn');
        const submitBtn = document.getElementById('submitBtn');
        const paymentStatus = document.getElementById('payment-status');
        const form = document.getElementById('admissionForm');
        
        // Element references
        const passportInput = document.getElementById('passport');
        const passportBase64Field = document.getElementById('passportBase64');
        const previewContainer = document.getElementById('preview-container');
        
        const birthCertInput = document.getElementById('birthCert');
        const birthCertBase64Field = document.getElementById('birthCertBase64');
        
        const olevelInput = document.getElementById('olevel');
        const olevelBase64Field = document.getElementById('olevelBase64');
        
        let transactionReference = null;

        // Apply compression handlers
        handleFileUpload(passportInput, passportBase64Field, previewContainer);
        handleFileUpload(birthCertInput, birthCertBase64Field);
        handleFileUpload(olevelInput, olevelBase64Field);

        payBtn.addEventListener('click', function(e) {
            e.preventDefault();
            const email = document.getElementById('email').value.trim();
            const fname = document.getElementById('firstName').value.trim();
            const lname = document.getElementById('lastName').value.trim();

            if (!email || !fname || !lname) {
                showCustomPopup("Please fill in first name, last name, and email before paying.", 'error', 'Missing Details');
                return;
            }

            const handler = PaystackPop.setup({
                key: PAYSTACK_PUBLIC_KEY,
                email: email,
                amount: APPLICATION_FEE_KOBO,
                currency: 'NGN',
                ref: ''+Math.floor((Math.random() * 1000000000) + 1),
                callback: function(response){
                    transactionReference = response.reference;
                    payBtn.classList.add('hidden');
                    paymentStatus.classList.remove('hidden');
                    submitBtn.disabled = false;
                    submitBtn.textContent = "Submit Application (Payment Confirmed)";
                    showCustomPopup("Payment Successful! Ref: " + transactionReference, 'success', 'Payment Confirmed');
                },
                onClose: function(){ showCustomPopup('Payment cancelled.', 'error', 'Payment Required'); }
            });
            handler.openIframe();
        });

        // --- SUBMISSION LOGIC ---
        form.addEventListener('submit', function(e) {
            e.preventDefault(); 
            
            if (!transactionReference) {
                showCustomPopup("Please complete payment first.", 'error', 'Payment Required');
                return; 
            }

            if (!form.checkValidity()) {
                showCustomPopup("Please fill in all required fields.", 'error', 'Incomplete Form');
                return;
            }

            document.getElementById('loading').classList.remove('hidden');
            submitBtn.disabled = true;
            submitBtn.textContent = "Sending Data...";

            const formData = new FormData(form);
            const dataObject = {};
            formData.forEach((value, key) => dataObject[key] = value);

            dataObject['passportBase64'] = passportBase64Field.value;
            dataObject['birthCertBase64'] = birthCertBase64Field.value;
            dataObject['olevelBase64'] = olevelBase64Field.value;
            dataObject['paymentRef'] = transactionReference;
            dataObject['action'] = 'submitApplication'; 

            // Convert to URLSearchParams for Apps Script compatibility (This handles large payloads better for POST)
            // But if files are huge (PDFs), this might still hit limits. 
            // The compression logic added above minimizes this risk for images.
            // Sending as JSON string for maximum compatibility with the new backend logic.
            
            fetch(SCRIPT_URL, {
                method: 'POST',
                // Using JSON.stringify here because the backend now robustly handles JSON input.
                // JSON is generally safer for large base64 strings than URL params.
                body: JSON.stringify(dataObject) 
            })
            .then(res => { if (!res.ok) throw new Error("HTTP " + res.status); return res.json(); })
            .then(data => {
                document.getElementById('loading').classList.add('hidden');
                if(data.result === "success") {
                    lastSubmittedData = { ...dataObject };
                    delete lastSubmittedData.birthCertBase64; 
                    delete lastSubmittedData.olevelBase64;      
                    showCustomPopup("Success! Your Admission Number is: " + data.admNo, 'success', 'Submitted!', [{ text: 'Close', handler: closeCustomPopup }, { text: 'Print', handler: () => printSummary(data.admNo), isPrimary: true }]);
                    form.reset();
                    submitBtn.textContent = "Submit Application";
                    payBtn.classList.remove('hidden');
                    paymentStatus.classList.add('hidden');
                    previewContainer.innerHTML = '';
                    transactionReference = null;
                } else {
                    showCustomPopup("Error: " + data.message, 'error', 'Failed');
                    submitBtn.disabled = false;
                }
            })
            .catch(err => {
                showCustomPopup("Network error.", 'error', 'Failed');
                document.getElementById('loading').classList.add('hidden');
                submitBtn.disabled = false;
            });
        });
    });
</script>
</body>
</html>
