<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Admission Portal with Paystack</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Paystack Standard Inline Script -->
    <script src="https://js.paystack.co/v1/inline.js"></script>
    <style>
        /* Custom styles for better aesthetics */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .container {
            max-width: 900px;
            width: 100%;
            margin: 2rem;
            background: white;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .form-group label {
            font-weight: 600;
            color: #374151;
            margin-bottom: 0.5rem;
            display: block;
        }
        .form-group input[type="text"],
        .form-group input[type="email"],
        .form-group select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            transition: border-color 0.2s;
        }
        .form-group input:focus, .form-group select:focus {
            border-color: #3b82f6;
            outline: none;
            box-shadow: 0 0 0 1px #3b82f6;
        }
        .row {
            display: flex;
            gap: 1rem;
        }
        .col {
            flex: 1;
            margin-bottom: 1rem;
        }
        fieldset {
            border: 1px solid #e5e7eb;
            padding: 1.5rem;
            margin-bottom: 2rem;
            border-radius: 0.75rem;
        }
        legend {
            font-size: 1.25rem;
            font-weight: 700;
            padding: 0 0.5rem;
            color: #1f2937;
        }
        /* Custom Modal Styling */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none; /* Hidden by default */
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.75rem;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }
    </style>
</head>
<body>

<div class="container">
    <header class="text-center mb-8">
        <h1 class="text-3xl font-bold text-gray-800">Student Application Form</h1>
        <p class="text-gray-500">Complete all sections and make the required payment to submit.</p>
    </header>

    <!-- Success/Error Modal -->
    <div id="statusModal" class="modal">
        <div class="modal-content">
            <h3 id="modalTitle" class="text-2xl font-bold mb-4"></h3>
            <p id="modalMessage" class="mb-6 text-gray-600"></p>
            <button id="modalCloseBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg shadow transition duration-150">Close</button>
        </div>
    </div>

    <form id="admissionForm">
        
        <fieldset>
            <legend>1. Biodata & Passport</legend>
            <div class="form-group mb-4">
                <label for="passport">Upload Passport Photograph (Max 2MB)</label>
                <input type="file" id="passport" accept="image/png, image/jpeg" required>
                <div id="preview-container" class="mt-2 w-24 h-24 rounded-full overflow-hidden border border-gray-300 flex items-center justify-center">
                    <img id="passport-preview" src="https://placehold.co/96x96/e5e7eb/6b7280?text=Photo" alt="Passport Preview" class="object-cover w-full h-full" onerror="this.src='https://placehold.co/96x96/e5e7eb/6b7280?text=Photo';">
                </div>
                <input type="hidden" id="passportBase64">
            </div>
            
            <div class="row">
                <div class="col">
                    <label>First Name</label>
                    <input type="text" name="firstName" required class="mt-1">
                </div>
                <div class="col">
                    <label>Last Name</label>
                    <input type="text" name="lastName" required class="mt-1">
                </div>
            </div>

            <div class="row">
                <div class="col">
                    <label>Email Address</label>
                    <input type="email" name="email" id="email" required class="mt-1">
                </div>
                <div class="col">
                    <label>Phone Number</label>
                    <input type="text" name="phone" required class="mt-1">
                </div>
            </div>

            <div class="row">
                <div class="col">
                    <label>Gender</label>
                    <select name="gender" required class="mt-1">
                        <option value="">Select...</option>
                        <option value="Male">Male</option>
                        <option value="Female">Female</option>
                    </select>
                </div>
                <div class="col">
                    <label>Date of Birth</label>
                    <input type="date" name="dob" required class="mt-1">
                </div>
            </div>
            
            <div class="form-group mb-4">
                <label>Address</label>
                <textarea name="address" rows="3" required class="w-full p-2 border border-gray-300 rounded-lg mt-1"></textarea>
            </div>
        </fieldset>

        <fieldset>
            <legend>2. Academic & Document Uploads</legend>
            <div class="form-group mb-4">
                <label>Course Applied For</label>
                <select name="courseApplied" required class="mt-1">
                    <option value="">Select...</option>
                    <option value="Community Health Extension Workers">Community Health Extension Workers</option>
                    <option value="Public Health">Public Health</option>
                    <option value="Pharmacy Technician">Pharmacy Technician</option>
                    <option value="Medical Laboratory Technician">Medical Laboratory Technician</option>
                </select>
            </div>

            <div class="row">
                <div class="col">
                    <label for="birthCert">Upload Birth Certificate (Max 2MB)</label>
                    <input type="file" id="birthCert" accept="application/pdf,image/*" required>
                    <input type="hidden" id="birthCertBase64">
                </div>
                <div class="col">
                    <label for="olevel">Upload O'Level Result (Max 2MB)</label>
                    <input type="file" id="olevel" accept="application/pdf,image/*" required>
                    <input type="hidden" id="olevelBase64">
                </div>
            </div>
        </fieldset>
        
        <fieldset class="text-center">
            <legend>3. Payment Summary</legend>
            <div class="text-2xl font-bold text-green-600 mb-4">
                Application Fee: <span id="feeDisplay">₦5,000.00</span>
            </div>
            <p class="text-sm text-gray-500">
                You will be redirected to the Paystack payment gateway upon clicking 'Pay & Submit'.
            </p>
        </fieldset>

        <div class="text-center mt-8">
            <button type="submit" id="submitBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-8 rounded-lg shadow-lg transition duration-200 disabled:opacity-50">
                Pay & Submit Application
            </button>
            <div id="loading" style="display: none;" class="mt-4 text-indigo-600 font-semibold">
                Processing payment and submission... Please wait.
            </div>
        </div>
    </form>
</div>

<script type="module">
    // --- Configuration ---
    // NOTE: Replace this with your actual Google Apps Script URL
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwGQORz9mdic63hpRIYJ9UiK8AyjzeFWMDYwH-f_iIWo4gn9afr38bVLE2piJDpY4oY4Q/exec'; 
    // NOTE: Replace this with your actual Paystack Public Key
    const PAYSTACK_PUBLIC_KEY = 'pk_test_29f23a0e0bde6c074ae9efb019002a8d95e721b4'; 
    // Application Fee in NGN (5000 NGN)
    const APPLICATION_FEE_NGN = 5000;
    // Paystack requires amount in kobo (NGN * 100)
    const APPLICATION_FEE_KOBO = APPLICATION_FEE_NGN * 100;

    // --- DOM Elements ---
    const form = document.getElementById('admissionForm');
    const submitBtn = document.getElementById('submitBtn');
    const loadingDiv = document.getElementById('loading');
    const feeDisplay = document.getElementById('feeDisplay');
    const passportInput = document.getElementById('passport');
    
    // Base64 hidden fields
    const passportBase64Field = document.getElementById('passportBase64');
    const birthCertBase64Field = document.getElementById('birthCertBase64');
    const olevelBase64Field = document.getElementById('olevelBase64');

    // --- Helper Functions ---

    /**
     * Converts a file input (image or PDF) to a Base64 string for embedding.
     * @param {File} file - The file object from the input.
     * @returns {Promise<string>} Base64 string (including data URI prefix).
     */
    const toBase64 = (file) => new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result);
        reader.onerror = error => reject(error);
    });

    /**
     * Custom Modal Function (replaces alert())
     */
    function showStatusModal(title, message, isSuccess = true) {
        const modal = document.getElementById('statusModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalMessage = document.getElementById('modalMessage');
        const modalCloseBtn = document.getElementById('modalCloseBtn');

        modalTitle.textContent = title;
        modalMessage.textContent = message;

        modalTitle.className = isSuccess ? 'text-2xl font-bold mb-4 text-green-600' : 'text-2xl font-bold mb-4 text-red-600';
        
        modal.style.display = 'flex';
        modalCloseBtn.onclick = () => {
            modal.style.display = 'none';
            if (isSuccess) {
                // Optionally redirect or reset on success
                form.reset();
            }
        };
        // Close modal when clicking outside
        modal.onclick = (e) => {
            if (e.target === modal) {
                modal.style.display = 'none';
            }
        };
    }

    // --- File Preview Logic ---
    passportInput.addEventListener('change', function() {
        const file = this.files[0];
        const preview = document.getElementById('passport-preview');
        if (file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                preview.src = e.target.result;
            };
            reader.readAsDataURL(file);
        } else {
            preview.src = 'https://placehold.co/96x96/e5e7eb/6b7280?text=Photo';
        }
    });

    // --- Paystack Integration ---

    /**
     * Initiates the Paystack payment gateway popup.
     * @param {string} email - Applicant's email address.
     * @param {number} amountKobo - Payment amount in kobo.
     * @param {Function} successCallback - Function to run on successful payment.
     */
    function payWithPaystack(email, amountKobo, successCallback) {
        let handler = PaystackPop.setup({
            key: PAYSTACK_PUBLIC_KEY,
            email: email,
            amount: amountKobo,
            currency: 'NGN', 
            // reference: '' // Paystack can generate a unique reference if omitted
            metadata: {
                custom_fields: [
                    {
                        display_name: "Application Fee",
                        variable_name: "application_fee",
                        value: APPLICATION_FEE_NGN
                    }
                ]
            },
            callback: function(response){
                // Payment was successful! Call the form submission logic.
                successCallback(response.reference);
            },
            onClose: function(){
                // User closed the payment popup
                loadingDiv.style.display = 'none';
                submitBtn.disabled = false;
                showStatusModal("Payment Cancelled", "The payment popup was closed. Please try again to submit your application.", false);
            }
        });
        handler.openIframe();
    }


    // --- Form Submission Logic (Now triggered by Paystack success) ---

    async function handleFormSubmission(transactionReference) {
        // 1. Gather all form data
        const formData = new FormData(form);
        const dataObject = {};
        formData.forEach((value, key) => dataObject[key] = value);

        // 2. Add the crucial Base64 documents and Payment Reference manually
        dataObject['passportBase64'] = passportBase64Field.value;
        dataObject['birthCertBase64'] = birthCertBase64Field.value;
        dataObject['olevelBase64'] = olevelBase64Field.value;
        dataObject['paymentRef'] = transactionReference; // Paystack reference

        // 3. Send the JSON data to the Google Apps Script Web App
        try {
            const response = await fetch(SCRIPT_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(dataObject)
            });

            const data = await response.json();
            loadingDiv.style.display = 'none';

            if(data.result === "success") {
                showStatusModal(
                    "Submission Successful!", 
                    "Your Admission Number is: " + data.admNo + ". Check your email shortly for the receipt.",
                    true
                );
            } else {
                // Submission failed *after* successful payment
                showStatusModal(
                    "Submission Error", 
                    "Payment was successful, but application submission failed: " + data.message + ". Please contact support with Payment Ref: " + transactionReference, 
                    false
                );
            }

        } catch (error) {
            console.error('Network or Server Error during submission:', error);
            loadingDiv.style.display = 'none';
            showStatusModal(
                "Network Error", 
                "A network error occurred during submission. Please check your connection and contact support with Payment Ref: " + transactionReference, 
                false
            );
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = "Pay & Submit Application";
        }
    }


    // --- Main Form Event Listener (Triggers Paystack) ---

    form.addEventListener('submit', async function(e) {
        e.preventDefault();

        // 1. Disable button and show loading
        submitBtn.disabled = true;
        submitBtn.textContent = "Loading...";
        loadingDiv.style.display = 'block';

        const emailInput = document.getElementById('email');
        const email = emailInput.value.trim();

        if (!email) {
            loadingDiv.style.display = 'none';
            submitBtn.disabled = false;
            submitBtn.textContent = "Pay & Submit Application";
            showStatusModal("Validation Error", "Please enter a valid email address.", false);
            return;
        }

        try {
            // 2. Convert files to Base64 first
            const [passportBase64, birthCertBase64, olevelBase64] = await Promise.all([
                toBase64(document.getElementById('passport').files[0]),
                toBase64(document.getElementById('birthCert').files[0]),
                toBase64(document.getElementById('olevel').files[0])
            ]);

            // Store Base64 strings in hidden fields
            passportBase64Field.value = passportBase64;
            birthCertBase64Field.value = birthCertBase64;
            olevelBase64Field.value = olevelBase64;

            // 3. Initiate Paystack payment
            payWithPaystack(email, APPLICATION_FEE_KOBO, handleFormSubmission);

            // Note: The loading indicator stays on until Paystack callback/onClose is executed.

        } catch (error) {
            console.error('File conversion error:', error);
            loadingDiv.style.display = 'none';
            submitBtn.disabled = false;
            submitBtn.textContent = "Pay & Submit Application";
            showStatusModal("File Error", "Could not process all file uploads. Please ensure all files are under 2MB.", false);
        }
    });

    // --- Initial Setup ---
    feeDisplay.textContent = `₦${APPLICATION_FEE_NGN.toLocaleString('en-NG')}.00`;

</script>
</body>
</html>
