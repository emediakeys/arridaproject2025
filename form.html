<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Apply Now | School Admission</title>

    <link rel="icon" type="image/png" sizes="32x32" href="icon.jpg">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #f3f4f6; background-image: radial-gradient(#e5e7eb 1px, transparent 1px); background-size: 24px 24px; }
        
        /* Smooth Transitions */
        .step-panel { display: none; opacity: 0; transform: translateX(20px); transition: all 0.4s ease-in-out; }
        .step-panel.active { display: block; opacity: 1; transform: translateX(0); }
        .step-panel.leaving { opacity: 0; transform: translateX(-20px); }

        /* Custom Form Inputs */
        .form-label { @apply block text-xs font-bold text-gray-500 uppercase mb-1 tracking-wide; }
        .form-input { @apply w-full px-4 py-3 rounded-lg border border-gray-300 bg-gray-50 text-gray-900 focus:bg-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200 outline-none; }
        .form-input.error { @apply border-red-500 ring-1 ring-red-500 bg-red-50; }

        /* Progress Bar */
        .progress-circle { @apply w-10 h-10 rounded-full flex items-center justify-center font-bold text-sm transition-all duration-300 z-10 border-2; }
        .progress-circle.active { @apply bg-blue-600 text-white border-blue-600 shadow-lg scale-110; }
        .progress-circle.completed { @apply bg-green-500 text-white border-green-500; }
        .progress-circle.pending { @apply bg-white text-gray-400 border-gray-200; }
        
        /* Custom File Upload */
        .file-upload-wrapper { @apply relative border-2 border-dashed border-gray-300 rounded-xl p-6 text-center hover:bg-blue-50 hover:border-blue-400 transition-colors cursor-pointer group; }
        
        /* Button Gradients */
        .btn-primary { @apply bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 transition-all duration-200; }
        
        /* Glassmorphism for Modal */
        .glass-modal { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center py-10 px-4">

    <a href="index.html" class="fixed top-6 right-6 z-50 bg-white/80 backdrop-blur px-4 py-2 rounded-full shadow-sm border border-gray-200 text-gray-500 hover:text-red-600 hover:bg-white transition-all duration-200 font-medium text-sm flex items-center gap-2 group">
        <span>Exit Application</span>
        <i class="fas fa-times-circle text-lg group-hover:rotate-90 transition-transform"></i>
    </a>

    <div class="max-w-4xl w-full bg-white rounded-3xl shadow-2xl overflow-hidden border border-gray-100 relative">
        
        <div class="bg-gradient-to-r from-blue-900 to-blue-800 p-8 text-white relative overflow-hidden">
            <div class="absolute top-0 right-0 opacity-10 transform translate-x-10 -translate-y-10">
                <i class="fas fa-graduation-cap text-9xl"></i>
            </div>
            <h1 class="text-3xl font-bold mb-2 relative z-10">Application Form</h1>
            <p class="text-blue-200 text-sm relative z-10">Complete the wizard below to join us. <br>Please ensure all details are accurate.</p>
        </div>

        <div class="px-8 py-6 bg-white border-b border-gray-100 sticky top-0 z-20">
            <div class="relative flex justify-between items-center max-w-2xl mx-auto">
                <div class="absolute top-1/2 left-0 w-full h-1 bg-gray-100 -z-0 rounded-full"></div>
                <div class="absolute top-1/2 left-0 h-1 bg-blue-600 -z-0 rounded-full transition-all duration-500" id="progressBar" style="width: 0%"></div>

                <div class="flex flex-col items-center gap-2 cursor-pointer" onclick="goToStep(1)">
                    <div class="progress-circle active" id="step-circle-1">1</div>
                    <span class="text-xs font-semibold text-gray-600 hidden sm:block">Biodata</span>
                </div>
                <div class="flex flex-col items-center gap-2 cursor-pointer" onclick="goToStep(2)">
                    <div class="progress-circle pending" id="step-circle-2">2</div>
                    <span class="text-xs font-semibold text-gray-600 hidden sm:block">Contact</span>
                </div>
                <div class="flex flex-col items-center gap-2 cursor-pointer" onclick="goToStep(3)">
                    <div class="progress-circle pending" id="step-circle-3">3</div>
                    <span class="text-xs font-semibold text-gray-600 hidden sm:block">Academics</span>
                </div>
                <div class="flex flex-col items-center gap-2">
                    <div class="progress-circle pending" id="step-circle-4"><i class="fas fa-credit-card"></i></div>
                    <span class="text-xs font-semibold text-gray-600 hidden sm:block">Payment</span>
                </div>
            </div>
        </div>

        <div class="p-6 sm:p-10 min-h-[400px]">
            <form id="admissionForm" autocomplete="off">
                
                <div id="step-1" class="step-panel active">
                    <div class="flex flex-col md:flex-row gap-8">
                        <div class="md:w-1/3 flex flex-col items-center">
                            <label class="form-label mb-2">Passport Photo</label>
                            <div class="relative w-40 h-40 rounded-full border-4 border-dashed border-gray-200 flex items-center justify-center overflow-hidden bg-gray-50 group hover:border-blue-400 transition-colors cursor-pointer" onclick="document.getElementById('passport').click()">
                                <img id="passportPreview" src="" class="absolute inset-0 w-full h-full object-cover hidden">
                                <div class="text-center p-4 text-gray-400 group-hover:text-blue-500 transition-colors" id="passportPlaceholder">
                                    <i class="fas fa-camera text-2xl mb-1"></i>
                                    <p class="text-[10px] uppercase font-bold">Click to Upload</p>
                                </div>
                            </div>
                            <input type="file" id="passport" accept="image/*" class="hidden" required>
                            <input type="hidden" id="passportBase64">
                            <p class="text-xs text-center text-gray-400 mt-2">Face only. Max 2MB.</p>
                        </div>

                        <div class="md:w-2/3 space-y-5">
                            <div class="grid grid-cols-2 gap-4">
                                <div><label class="form-label">First Name</label><input type="text" id="firstName" class="form-input" placeholder="e.g. John" required></div>
                                <div><label class="form-label">Last Name</label><input type="text" id="lastName" class="form-input" placeholder="e.g. Doe" required></div>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div><label class="form-label">Date of Birth</label><input type="date" id="dob" class="form-input" required></div>
                                <div>
                                    <label class="form-label">Gender</label>
                                    <select id="gender" class="form-input" required>
                                        <option value="">Select</option>
                                        <option value="Male">Male</option>
                                        <option value="Female">Female</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="step-2" class="step-panel">
                    <div class="space-y-6">
                        <div>
                            <label class="form-label">Home Address</label>
                            <textarea id="address" rows="2" class="form-input" placeholder="Full residential address" required></textarea>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="form-label">Email Address</label>
                                <div class="relative">
                                    <i class="fas fa-envelope absolute left-4 top-3.5 text-gray-400"></i>
                                    <input type="email" id="email" class="form-input pl-10" placeholder="student@email.com" required>
                                </div>
                            </div>
                            <div>
                                <label class="form-label">Phone Number</label>
                                <div class="relative">
                                    <i class="fas fa-phone absolute left-4 top-3.5 text-gray-400"></i>
                                    <input type="tel" id="phone" class="form-input pl-10" placeholder="080..." required>
                                </div>
                            </div>
                        </div>
                        <div class="bg-blue-50 p-5 rounded-xl border border-blue-100">
                            <label class="form-label text-blue-800">Create Portal Password</label>
                            <div class="relative mt-1">
                                <input type="password" id="password" class="form-input bg-white border-blue-200" placeholder="••••••••" required>
                                <i class="fas fa-lock absolute right-4 top-3.5 text-blue-300"></i>
                            </div>
                            <p class="text-xs text-blue-600 mt-2 flex items-center"><i class="fas fa-info-circle mr-1"></i> You will use this to log in later.</p>
                        </div>
                    </div>
                </div>

                <div id="step-3" class="step-panel">
                    <div class="space-y-6">
                        <div>
                            <label class="form-label">Course of Choice</label>
                            <select id="course" class="form-input font-medium" required>
                                <option value="">-- Select Course --</option>
                                <option value="Community Health Extension Workers">Community Health Extension Workers</option>
                                <option value="Public Health">Public Health</option>
                                <option value="Pharmacy Technician">Pharmacy Technician</option>
                                <option value="Medical Laboratory Technician">Medical Laboratory Technician</option>
                            </select>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="file-upload-wrapper" onclick="document.getElementById('birthCert').click()">
                                <i class="fas fa-file-pdf text-3xl text-gray-300 mb-2 group-hover:text-blue-500 transition-colors"></i>
                                <p class="text-sm font-bold text-gray-700">Upload Birth Cert</p>
                                <p class="text-xs text-gray-400" id="birthCertName">Click to browse (PDF/Img)</p>
                                <input type="file" id="birthCert" accept=".pdf, image/*" class="hidden">
                                <input type="hidden" id="birthCertBase64">
                            </div>

                            <div class="file-upload-wrapper" onclick="document.getElementById('olevel').click()">
                                <i class="fas fa-file-certificate text-3xl text-gray-300 mb-2 group-hover:text-blue-500 transition-colors"></i>
                                <p class="text-sm font-bold text-gray-700">Upload O'Level</p>
                                <p class="text-xs text-gray-400" id="olevelName">Click to browse (PDF/Img)</p>
                                <input type="file" id="olevel" accept=".pdf, image/*" class="hidden">
                                <input type="hidden" id="olevelBase64">
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="form-label">Sponsor Name</label><input type="text" id="sponsor" class="form-input" required></div>
                            <div><label class="form-label">Next of Kin Phone</label><input type="tel" id="nokPhone" class="form-input" required></div>
                        </div>
                    </div>
                </div>

                <div id="step-4" class="step-panel text-center">
                    <div class="bg-gray-50 rounded-2xl p-8 border border-gray-100 max-w-sm mx-auto mb-8 relative overflow-hidden">
                        <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-blue-500 to-green-500"></div>
                        <p class="text-gray-500 text-sm uppercase tracking-widest mb-1">Total Fee</p>
                        <h2 class="text-4xl font-extrabold text-gray-900 mb-4">₦7,500<span class="text-lg text-gray-400 font-normal">.00</span></h2>
                        <ul class="text-left text-sm text-gray-600 space-y-2 mb-6 border-t border-gray-200 pt-4">
                            <li class="flex justify-between"><span>Application Form</span> <span class="font-bold">₦7,500</span></li>
                            <li class="flex justify-between"><span>Processing</span> <span class="font-bold">Free</span></li>
                        </ul>
                        <button type="button" id="payBtn" class="w-full py-3 bg-gray-900 text-white font-bold rounded-xl hover:bg-gray-800 transition shadow-lg flex items-center justify-center gap-2">
                            <i class="fas fa-lock"></i> Pay Securely
                        </button>
                    </div>
                    
                    <div id="payment-success-msg" class="hidden animate-bounce">
                        <div class="inline-flex items-center gap-2 px-6 py-3 bg-green-100 text-green-700 rounded-full font-bold text-sm">
                            <i class="fas fa-check-circle"></i> Payment Successful! Click Submit.
                        </div>
                    </div>
                </div>

                <div class="mt-10 pt-6 border-t border-gray-100 flex justify-between items-center">
                    <button type="button" id="prevBtn" class="hidden px-6 py-2.5 rounded-xl text-gray-500 font-bold hover:bg-gray-100 transition">
                        <i class="fas fa-arrow-left mr-2"></i> Back
                    </button>
                    <div class="flex-1"></div> <button type="button" id="nextBtn" class="btn-primary px-8 py-3 rounded-xl font-bold flex items-center">
                        Next Step <i class="fas fa-arrow-right ml-2"></i>
                    </button>
                    <button type="submit" id="submitBtn" class="hidden btn-primary bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 px-10 py-3 rounded-xl font-bold shadow-green-200" disabled>
                        Submit Application
                    </button>
                </div>

            </form>
        </div>
    </div>

    <div id="loadingOverlay" class="fixed inset-0 bg-white/90 backdrop-blur-sm hidden items-center justify-center z-50">
        <div class="text-center">
            <div class="w-16 h-16 border-4 border-blue-200 border-t-blue-600 rounded-full animate-spin mx-auto mb-4"></div>
            <h3 class="text-lg font-bold text-gray-800">Processing...</h3>
            <p class="text-sm text-gray-500">Please do not close this window.</p>
        </div>
    </div>

    <div id="popupModal" class="fixed inset-0 modal-overlay hidden items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-6 max-w-sm w-full glass-modal transform scale-100 transition-all">
            <div id="popupIcon" class="flex justify-center mb-4 text-4xl"></div>
            <h3 id="popupTitle" class="text-xl font-bold text-center text-gray-900 mb-2"></h3>
            <p id="popupMessage" class="text-center text-gray-600 mb-6 text-sm"></p>
            <div id="popupActions" class="flex justify-center gap-3"></div>
        </div>
    </div>

    <script src="https://js.paystack.co/v1/inline.js"></script>
    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyMEpK3kKSrQR99hvVBA0fvs-_eWGKHzfQutXHy7X369_ELy0t8BpI-2mrSYnWKVkNX4Q/exec"; 
        const PAYSTACK_KEY = "pk_test_29f23a0e0bde6c074ae9efb019002a8d95e721b4";
        const FEE_KOBO = 750000;

        let currentStep = 1;
        let transactionReference = null;
        let lastData = null;

        // UI Helpers
        const dom = {
            form: document.getElementById('admissionForm'),
            nextBtn: document.getElementById('nextBtn'),
            prevBtn: document.getElementById('prevBtn'),
            submitBtn: document.getElementById('submitBtn'),
            progressBar: document.getElementById('progressBar'),
            popup: document.getElementById('popupModal'),
            loading: document.getElementById('loadingOverlay')
        };

        function updateSteps() {
            // Panel Transition
            document.querySelectorAll('.step-panel').forEach(p => {
                p.classList.remove('active');
                if(p.id === `step-${currentStep}`) setTimeout(() => p.classList.add('active'), 50);
            });

            // Progress Bar
            dom.progressBar.style.width = `${((currentStep - 1) / 3) * 100}%`;

            // Circles
            for(let i=1; i<=4; i++) {
                const el = document.getElementById(`step-circle-${i}`);
                el.className = `progress-circle ${i === currentStep ? 'active' : (i < currentStep ? 'completed' : 'pending')}`;
                if(i < currentStep) el.innerHTML = '<i class="fas fa-check"></i>';
                else if (i === 4) el.innerHTML = '<i class="fas fa-credit-card"></i>';
                else el.textContent = i;
            }

            // Buttons
            dom.prevBtn.classList.toggle('hidden', currentStep === 1);
            if(currentStep === 4) {
                dom.nextBtn.classList.add('hidden');
                dom.submitBtn.classList.remove('hidden');
            } else {
                dom.nextBtn.classList.remove('hidden');
                dom.submitBtn.classList.add('hidden');
            }
        }

        function validateCurrentStep() {
            const panel = document.getElementById(`step-${currentStep}`);
            const inputs = panel.querySelectorAll('input, select, textarea');
            let valid = true;
            inputs.forEach(input => {
                if(input.hasAttribute('required') && !input.value.trim()) {
                    input.classList.add('error');
                    // Shake animation
                    input.parentElement.classList.add('animate-pulse');
                    setTimeout(() => input.parentElement.classList.remove('animate-pulse'), 500);
                    input.addEventListener('input', () => input.classList.remove('error'), {once:true});
                    valid = false;
                }
            });
            
            // Custom checks
            if(currentStep === 1 && !document.getElementById('passportBase64').value) {
                showPopup("Upload Passport", "Please upload a passport photograph.", "error");
                valid = false;
            }
            return valid;
        }

        dom.nextBtn.addEventListener('click', () => {
            if(validateCurrentStep()) { currentStep++; updateSteps(); }
        });
        dom.prevBtn.addEventListener('click', () => {
            currentStep--; updateSteps();
        });

        // File Handling (Compressed)
        function setupFile(inputId, hiddenId, previewId=null, nameId=null) {
            const input = document.getElementById(inputId);
            input.addEventListener('change', e => {
                const file = e.target.files[0];
                if(!file) return;
                if(file.size > 2*1024*1024) { showPopup("Error", "File too large (>2MB).", "error"); input.value=""; return; }
                
                // Show Name
                if(nameId) document.getElementById(nameId).innerText = file.name;

                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = ev => {
                    if(file.type.startsWith('image/')) {
                        const img = new Image();
                        img.src = ev.target.result;
                        img.onload = () => {
                            const cvs = document.createElement('canvas');
                            const scale = inputId === 'passport' ? 300 : 900;
                            let w = img.width, h = img.height;
                            if(w > scale) { h *= scale/w; w = scale; }
                            cvs.width = w; cvs.height = h;
                            cvs.getContext('2d').drawImage(img,0,0,w,h);
                            const b64 = cvs.toDataURL('image/jpeg', 0.6);
                            document.getElementById(hiddenId).value = b64;
                            if(previewId) {
                                document.getElementById(previewId).src = b64;
                                document.getElementById(previewId).classList.remove('hidden');
                                document.getElementById('passportPlaceholder').classList.add('hidden');
                            }
                        }
                    } else {
                        // PDF
                        document.getElementById(hiddenId).value = ev.target.result;
                    }
                }
            });
        }

        setupFile('passport', 'passportBase64', 'passportPreview');
        setupFile('birthCert', 'birthCertBase64', null, 'birthCertName');
        setupFile('olevel', 'olevelBase64', null, 'olevelName');

        // Paystack
        document.getElementById('payBtn').addEventListener('click', () => {
            const email = document.getElementById('email').value;
            if(!email) { showPopup("Missing Email", "Please go back and fill in your email.", "error"); return; }
            
            const handler = PaystackPop.setup({
                key: PAYSTACK_KEY,
                email: email,
                amount: FEE_KOBO,
                currency: 'NGN',
                ref: ''+Math.floor((Math.random() * 1000000000) + 1),
                callback: function(res) {
                    transactionReference = res.reference;
                    document.getElementById('payBtn').classList.add('hidden');
                    document.getElementById('payment-success-msg').classList.remove('hidden');
                    dom.submitBtn.disabled = false;
                    dom.submitBtn.classList.remove('from-green-600', 'to-green-700'); // Reset style if needed
                    showPopup("Payment Confirmed", "Payment successful! Please click 'Submit Application' to finish.", "success");
                },
                onClose: () => showPopup("Cancelled", "Payment cancelled.", "error")
            });
            handler.openIframe();
        });

        // Submit
        dom.form.addEventListener('submit', e => {
            e.preventDefault();
            if(!transactionReference) { showPopup("Payment Required", "Please pay the application fee first.", "error"); return; }
            
            dom.loading.classList.remove('hidden');
            dom.loading.classList.add('flex');
            
            const fd = new FormData(dom.form);
            const obj = {};
            fd.forEach((v,k) => obj[k] = v);
            obj['passportBase64'] = document.getElementById('passportBase64').value;
            obj['birthCertBase64'] = document.getElementById('birthCertBase64').value;
            obj['olevelBase64'] = document.getElementById('olevelBase64').value;
            obj['paymentRef'] = transactionReference;
            obj['action'] = 'submitApplication';

            fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(obj) })
            .then(r => r.json())
            .then(d => {
                dom.loading.classList.remove('flex');
                dom.loading.classList.add('hidden');
                if(d.result === 'success') {
                    lastData = obj;
                    showPopup(`Success! ID: ${d.admNo}`, "success", "Application Submitted", [
                        { text: "Print Slip", handler: () => printSlip(d.admNo), primary: true },
                        { text: "Close", handler: () => location.reload(), primary: false }
                    ]);
                } else {
                    showPopup("Submission Failed", d.message, "error");
                }
            })
            .catch(() => {
                dom.loading.classList.add('hidden');
                showPopup("Network Error", "Please try again.", "error");
            });
        });

        // Print Slip
        function printSlip(id) {
            document.getElementById('popupModal').classList.add('hidden');
            const d = lastData;
            document.body.innerHTML = `
                <div class="max-w-2xl mx-auto p-10 bg-white border mt-10">
                    <div class="text-center border-b pb-6 mb-6">
                        <h1 class="text-3xl font-bold text-blue-900">Application Acknowledgement</h1>
                        <p class="text-gray-500">Keep this slip safe</p>
                    </div>
                    <div class="flex justify-between mb-8">
                        <div>
                            <p class="text-xs text-gray-400 uppercase">Applicant</p>
                            <h2 class="text-2xl font-bold">${d.firstName} ${d.lastName}</h2>
                            <p>${d.email}</p>
                            <p>${d.phone}</p>
                        </div>
                        <img src="${d.passportBase64}" class="w-32 h-32 object-cover border-4 border-gray-100 rounded-lg">
                    </div>
                    <div class="grid grid-cols-2 gap-6 bg-gray-50 p-6 rounded-xl">
                        <div><p class="text-xs text-gray-400">Admission No</p><p class="font-bold font-mono text-lg">${id}</p></div>
                        <div><p class="text-xs text-gray-400">Course</p><p class="font-bold">${d.course}</p></div>
                        <div><p class="text-xs text-gray-400">Payment Ref</p><p class="font-mono">${d.paymentRef}</p></div>
                        <div><p class="text-xs text-gray-400">Date</p><p>${new Date().toLocaleDateString()}</p></div>
                    </div>
                    <div class="mt-10 text-center print:hidden"><button onclick="window.print()" class="px-6 py-2 bg-blue-600 text-white rounded-lg">Print</button></div>
                </div>
            `;
        }

        // Popup System
        function showPopup(title, msg, type='success', actions=[]) {
            const p = dom.popup;
            document.getElementById('popupTitle').innerText = title;
            document.getElementById('popupMessage').innerText = msg;
            document.getElementById('popupIcon').innerHTML = type==='success' 
                ? '<i class="fas fa-check-circle text-green-500"></i>' 
                : '<i class="fas fa-times-circle text-red-500"></i>';
            
            const actDiv = document.getElementById('popupActions');
            actDiv.innerHTML = '';
            if(actions.length === 0) actions.push({ text: 'OK', handler: () => p.classList.remove('flex', 'hidden') || p.classList.add('hidden'), primary: true});
            
            actions.forEach(a => {
                const btn = document.createElement('button');
                btn.innerText = a.text;
                btn.className = `px-4 py-2 rounded-lg text-sm font-bold ${a.primary ? 'bg-gray-900 text-white' : 'bg-gray-100 text-gray-700'}`;
                btn.onclick = a.handler;
                actDiv.appendChild(btn);
            });

            p.classList.remove('hidden');
            p.classList.add('flex');
        }

        updateSteps();
    </script>
</body>
</html>
