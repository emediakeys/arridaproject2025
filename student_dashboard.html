<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Portal - Dashboard</title>
    
    <link rel="icon" type="image/png" sizes="32x32" href="icon.jpg">
    <link rel="icon" type="image/png" sizes="16x16" href="icon.jpg">
    <link rel="apple-touch-icon" href="icon.jpg">

    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://js.paystack.co/v1/inline.js"></script>

    <style>
        /* Custom styles for dashboard */
        :root { --primary-color: #3b82f6; }
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .nav-item { display: flex; align-items: center; padding: 0.75rem 1rem; cursor: pointer; border-radius: 0.5rem; margin-bottom: 0.5rem; transition: all 0.2s; }
        .nav-item:hover, .nav-item.active { background-color: var(--primary-color); color: white; box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.3); }
        .card { background-color: white; padding: 1.5rem; border-radius: 0.75rem; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
        .form-input { width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.5rem; transition: all 0.15s; }
        .form-input:focus { border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5); outline: none; }
        
        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #e5e7eb; border-radius: 4px; }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>

    <div id="app" class="min-h-screen flex flex-col md:flex-row bg-gray-100 relative overflow-hidden"></div>

    <div id="messageModal" class="fixed inset-0 bg-gray-600 bg-opacity-75 hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl shadow-2xl max-w-sm w-full p-6">
            <h3 id="modalTitle" class="text-xl font-semibold text-gray-900 mb-3">Message</h3>
            <p id="modalMessage" class="text-gray-700 mb-6"></p>
            <button onclick="closeModal()" class="w-full py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition">Close</button>
        </div>
    </div>
    
    <div id="apiLoadingOverlay" class="fixed inset-0 bg-gray-600 bg-opacity-75 hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl shadow-2xl max-w-sm w-full p-6 text-center">
            <i class="fas fa-spinner fa-spin text-4xl text-blue-500"></i>
            <p class="mt-4 text-gray-600 font-semibold" id="loadingMessage">Processing request...</p>
        </div>
    </div>

    <script>
        const ENDPOINT_URL = 'https://script.google.com/macros/s/AKfycbyMEpK3kKSrQR99hvVBA0fvs-_eWGKHzfQutXHy7X369_ELy0t8BpI-2mrSYnWKVkNX4Q/exec';
        
        // YOUR PAYSTACK PUBLIC KEY
        const PAYSTACK_PUBLIC_KEY = 'pk_test_34033a8e8865add5341146621b171d687d606024'; 

        let studentData = {};
        let currentTab = 'profile';
        let isSidebarOpen = false;

        // --- UTILS ---
        function showMessage(title, message, isSuccess = true) {
            setLoading(false); 
            const modal = document.getElementById('messageModal');
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalMessage').textContent = message;
            const titleEl = document.getElementById('modalTitle');
            titleEl.className = isSuccess ? 'text-xl font-semibold mb-3 text-green-600' : 'text-xl font-semibold mb-3 text-red-600';
            modal.classList.remove('hidden'); modal.classList.add('flex');
        }
        function closeModal() { document.getElementById('messageModal').classList.remove('flex'); document.getElementById('messageModal').classList.add('hidden'); }
        function setLoading(isLoading, message = 'Processing...') {
            const overlay = document.getElementById('apiLoadingOverlay');
            if (isLoading) { document.getElementById('loadingMessage').textContent = message; overlay.classList.remove('hidden'); overlay.classList.add('flex'); }
            else { overlay.classList.remove('flex'); overlay.classList.add('hidden'); }
        }
        function toggleSidebar() {
            isSidebarOpen = !isSidebarOpen;
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            if (isSidebarOpen) { sidebar.classList.remove('-translate-x-full'); sidebar.classList.add('translate-x-0'); overlay.classList.remove('hidden'); }
            else { sidebar.classList.add('-translate-x-full'); sidebar.classList.remove('translate-x-0'); overlay.classList.add('hidden'); }
        }
        function getAcademicSession() {
            const now = new Date();
            const year = now.getFullYear();
            return now.getMonth() >= 8 ? `${year}/${year + 1}` : `${year - 1}/${year}`;
        }

        async function makeApiCall(data) {
            try {
                const response = await fetch(ENDPOINT_URL, {
                    method: 'POST', mode: 'cors', cache: 'no-cache',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams(data)
                });
                return await response.json();
            } catch (e) { setLoading(false); throw e; }
        }

        // --- AUTH & SYNC ---
        
        function checkAuth() {
            const storedData = localStorage.getItem('studentData');
            if (storedData) { 
                studentData = JSON.parse(storedData); 
                renderDashboard(); 
                // NEW: Background sync to check if payments changed (e.g. wiped by admin)
                syncPaymentStatus();
            } 
            else { renderLogin(); }
        }

        // NEW FUNCTION: SYNC PAYMENT STATUS FROM SERVER
        async function syncPaymentStatus() {
            try {
                const response = await makeApiCall({ action: 'checkPaymentStatus', admNo: studentData.admNo });
                if(response.result === 'success') {
                    // Update Local State
                    studentData.hasPaidAcceptance = response.hasPaidAcceptance;
                    studentData.hasPaidTuition = response.hasPaidTuition;
                    localStorage.setItem('studentData', JSON.stringify(studentData));
                    
                    // If currently on a payment-related tab, re-render to show updates
                    if(currentTab === 'payments' || currentTab === 'letter') {
                        loadTabContent(currentTab);
                    }
                }
            } catch(e) { console.log("Background sync failed"); }
        }

        function handleLogout() { localStorage.removeItem('studentData'); studentData = {}; isSidebarOpen = false; renderLogin(); }

        async function handleStudentLogin(event) {
            event.preventDefault(); 
            const admNo = document.getElementById('admNo').value;
            const password = document.getElementById('password').value;
            setLoading(true, 'Authenticating...');
            try {
                const response = await makeApiCall({ action: 'studentLogin', admNo, password });
                setLoading(false);
                if (response.result === 'success') {
                    studentData = {
                        admNo: response.data.Admission_No,
                        firstName: response.data['First Name'],
                        lastName: response.data.Last_Name,
                        email: response.data.Email,
                        course: response.data.Course_Applied,
                        hasPaidAcceptance: response.data.hasPaidAcceptance,
                        hasPaidTuition: response.data.hasPaidTuition
                    };
                    localStorage.setItem('studentData', JSON.stringify(studentData));
                    showMessage('Success', `Welcome back, ${studentData.firstName}!`, true);
                    renderDashboard();
                } else { showMessage('Login Failed', response.message || 'Invalid Credentials.', false); }
            } catch (e) { showMessage('Error', 'Connection failed.', false); }
        }

        // --- PAYMENT LOGIC ---
        function initPaystack(amount, feeType) {
            const handler = PaystackPop.setup({
                key: PAYSTACK_PUBLIC_KEY,
                email: studentData.email,
                amount: amount * 100,
                currency: 'NGN',
                ref: '' + Math.floor((Math.random() * 1000000000) + 1), 
                metadata: { custom_fields: [{ display_name: "Admission No", variable_name: "adm_no", value: studentData.admNo }] },
                callback: function(response) {
                    setLoading(true, 'Verifying Payment...');
                    makeApiCall({
                        action: 'verifyPayment',
                        reference: response.reference,
                        admNo: studentData.admNo,
                        amount: amount,
                        feeType: feeType
                    }).then(res => {
                        setLoading(false);
                        if(res.result === 'success') {
                            if(feeType === 'Acceptance') studentData.hasPaidAcceptance = true;
                            if(feeType === 'Tuition') studentData.hasPaidTuition = true;
                            localStorage.setItem('studentData', JSON.stringify(studentData));
                            showMessage("Success", "Payment successful! Dashboard updating...", true);
                            setTimeout(() => renderDashboard(), 1500);
                        } else {
                            showMessage("Verification Failed", "Payment could not be verified.", false);
                        }
                    });
                },
                onClose: function() { alert('Transaction was not completed.'); }
            });
            handler.openIframe();
        }

        // --- RENDERERS ---
        function renderLogin() {
            document.getElementById('app').innerHTML = `
                <div class="min-h-screen flex items-center justify-center w-full p-4 bg-gray-200">
                    <div class="card w-full max-w-md">
                        <h2 class="text-3xl font-bold text-center text-blue-600 mb-6">Student Login</h2>
                        <form id="loginForm">
                            <div class="mb-4"><label class="block text-gray-700 font-medium mb-2">Admission Number</label><input type="text" id="admNo" class="form-input" required placeholder="e.g., ADM-001"></div>
                            <div class="mb-6"><label class="block text-gray-700 font-medium mb-2">Password</label><input type="password" id="password" class="form-input" required placeholder="••••••••"></div>
                            <button type="submit" class="w-full py-3 bg-blue-500 text-white font-bold rounded-lg hover:bg-blue-600 transition">Log In</button>
                        </form>
                    </div>
                </div>`;
            document.getElementById('loginForm').onsubmit = handleStudentLogin;
        }

        function renderDashboard() {
            const tabs = [
                { id: 'profile', icon: 'fas fa-user-circle', label: 'My Profile' },
                { id: 'announcements', icon: 'fas fa-bullhorn', label: 'News Feed' },
                { id: 'assignments', icon: 'fas fa-tasks', label: 'Assignments' },
                { id: 'letter', icon: 'fas fa-file-alt', label: 'Admission Letter' },
                { id: 'payments', icon: 'fas fa-wallet', label: 'Payments' },
            ];
            document.getElementById('app').innerHTML = `
                <div id="sidebarOverlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden md:hidden"></div>
                <div id="sidebar" class="fixed inset-y-0 left-0 z-50 w-64 bg-white shadow-2xl transform transition-transform duration-300 -translate-x-full md:translate-x-0 md:static flex flex-col">
                    <div class="p-4 border-b border-gray-100 bg-blue-50 flex justify-between"><div class="font-bold text-lg text-gray-800"><i class="fas fa-graduation-cap text-blue-500 mr-2"></i>Student Portal</div><button onclick="toggleSidebar()" class="md:hidden text-red-500"><i class="fas fa-times"></i></button></div>
                    <div class="p-4 border-b border-gray-100"><p class="font-bold text-gray-800 truncate">${studentData.firstName}</p><p class="text-xs text-gray-500">${studentData.admNo}</p></div>
                    <nav class="flex-grow p-4 space-y-1 overflow-y-auto">
                        ${tabs.map(tab => `<div class="nav-item ${currentTab === tab.id ? 'active' : 'text-gray-600 hover:bg-gray-50'}" data-tab="${tab.id}"><i class="${tab.icon} w-6 mr-2 text-center"></i><span>${tab.label}</span></div>`).join('')}
                    </nav>
                    <div class="p-4 border-t"><button id="logoutBtn" class="w-full p-3 text-red-500 hover:bg-red-50 rounded-lg"><i class="fas fa-sign-out-alt mr-2"></i> Logout</button></div>
                </div>
                <main class="flex-grow flex flex-col h-screen overflow-hidden bg-gray-50">
                    <div class="md:hidden bg-white p-4 shadow-sm flex justify-between items-center"><button onclick="toggleSidebar()"><i class="fas fa-bars text-xl"></i></button><h1 class="text-lg font-bold capitalize">${tabs.find(t=>t.id===currentTab).label}</h1><div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center text-blue-600 font-bold text-xs">${studentData.firstName.charAt(0)}</div></div>
                    <div class="flex-grow overflow-y-auto p-4 md:p-8" id="contentScrollArea">
                        <h1 class="text-3xl font-bold text-gray-800 mb-6 hidden md:block capitalize">${tabs.find(t=>t.id===currentTab).label}</h1>
                        <div id="portalContent"></div>
                    </div>
                </main>`;
            
            document.querySelectorAll('.nav-item').forEach(i => i.onclick = () => { currentTab = i.dataset.tab; renderDashboard(); });
            document.getElementById('logoutBtn').onclick = handleLogout;
            loadTabContent(currentTab);
        }

        function loadTabContent(tab) {
            const content = document.getElementById('portalContent');
            content.innerHTML = `<div class="text-center py-20"><i class="fas fa-spinner fa-spin text-4xl text-blue-500"></i><p class="mt-4 text-gray-600">Loading...</p></div>`;

            if(tab === 'profile') {
                content.innerHTML = `<div class="max-w-4xl mx-auto"><div class="card grid md:grid-cols-2 gap-6"><div class="col-span-2 border-b pb-4 mb-2 flex items-center"><div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center text-2xl text-blue-600 font-bold mr-4">${studentData.firstName.charAt(0)}</div><div><h3 class="text-xl font-bold">${studentData.firstName} ${studentData.lastName}</h3><p class="text-gray-500">Student</p></div></div><div class="p-4 border rounded bg-gray-50"><p class="text-xs font-bold text-gray-400">Adm No</p><p class="font-mono text-blue-800 font-bold">${studentData.admNo}</p></div><div class="p-4 border rounded bg-gray-50"><p class="text-xs font-bold text-gray-400">Email</p><p>${studentData.email}</p></div><div class="p-4 border rounded bg-gray-50"><p class="text-xs font-bold text-gray-400">Course</p><p class="text-green-700 font-bold">${studentData.course}</p></div><div class="p-4 border rounded bg-gray-50"><p class="text-xs font-bold text-gray-400">Session</p><p>${getAcademicSession()}</p></div></div></div>`;
            } else if (tab === 'letter') {
                // FORCE SYNC WHEN OPENING THIS TAB
                syncPaymentStatus().then(() => {
                    if (studentData.hasPaidAcceptance) {
                        content.innerHTML = `
                            <div class="max-w-2xl mx-auto card text-center p-10">
                                <div class="w-16 h-16 bg-blue-50 text-blue-500 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl"><i class="fas fa-file-alt"></i></div>
                                <h2 class="text-xl font-bold text-gray-900 mb-2">Admission Letter</h2>
                                <p class="text-gray-500 mb-6">Your admission has been confirmed. You can now download your letter.</p>
                                <button onclick="handleDownloadLetter()" class="bg-blue-600 text-white px-6 py-3 rounded-xl font-bold shadow-lg hover:bg-blue-700 transition transform hover:-translate-y-1">
                                    <i class="fas fa-download mr-2"></i> Download PDF
                                </button>
                            </div>`;
                    } else {
                        content.innerHTML = `
                            <div class="max-w-2xl mx-auto card text-center p-10 border-2 border-yellow-100">
                                <div class="w-16 h-16 bg-yellow-50 text-yellow-600 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl"><i class="fas fa-lock"></i></div>
                                <h2 class="text-xl font-bold text-gray-900 mb-2">Admission Letter Locked</h2>
                                <p class="text-gray-500 mb-6">You must pay your <strong>Acceptance Fee (₦10,000)</strong> to access your admission letter.</p>
                                <button onclick="initPaystack(10000, 'Acceptance')" class="bg-yellow-500 text-white px-6 py-3 rounded-xl font-bold shadow-lg hover:bg-yellow-600 transition transform hover:-translate-y-1">
                                    <i class="fas fa-credit-card mr-2"></i> Pay Acceptance Fee
                                </button>
                            </div>`;
                    }
                });
            } else if (tab === 'payments') {
                // FORCE SYNC WHEN OPENING THIS TAB
                syncPaymentStatus().then(() => {
                    const showAcceptance = !studentData.hasPaidAcceptance;
                    const showTuition = !studentData.hasPaidTuition;
                    let formHTML = '';

                    if (!showAcceptance && !showTuition) {
                        formHTML = `<div class="card text-center p-10 bg-green-50 border border-green-200"><i class="fas fa-check-circle text-4xl text-green-500 mb-4"></i><h3 class="text-xl font-bold text-green-800">All Fees Paid!</h3><p class="text-green-600">You are fully cleared for this session.</p></div>`;
                    } else {
                        formHTML = `
                            <div class="card">
                                <h3 class="font-bold text-gray-800 mb-4 border-b pb-2">Make Payment</h3>
                                <form onsubmit="event.preventDefault(); const amt=this.amount.value; const type=this.type.value; initPaystack(amt, type);">
                                    <div class="grid md:grid-cols-2 gap-4 mb-4">
                                        <div><label class="block text-sm mb-1">Fee Type</label>
                                            <select name="type" class="form-input bg-white" onchange="this.form.amount.value = (this.value==='Acceptance'?10000:50000)">
                                                ${showAcceptance ? '<option value="Acceptance">Acceptance Fee</option>' : ''}
                                                ${showTuition ? '<option value="Tuition">Tuition Fee</option>' : ''}
                                            </select>
                                        </div>
                                        <div><label class="block text-sm mb-1">Amount (₦)</label><input type="number" name="amount" value="${showAcceptance ? '10000' : '50000'}" readonly class="form-input bg-gray-50"></div>
                                    </div>
                                    <button type="submit" class="w-full bg-green-600 text-white font-bold py-3 rounded-lg hover:bg-green-700">Proceed to Pay</button>
                                </form>
                            </div>`;
                    }

                    content.innerHTML = `
                        <div class="max-w-4xl mx-auto space-y-6">
                            <div class="grid md:grid-cols-2 gap-4">
                                <div class="bg-white p-4 rounded-xl shadow-sm border ${studentData.hasPaidAcceptance ? 'border-green-200 bg-green-50' : 'border-gray-200'}">
                                    <p class="text-xs font-bold text-gray-400 uppercase">Acceptance Fee</p>
                                    <p class="text-2xl font-bold text-gray-800">₦10,000</p>
                                    <p class="text-xs font-bold ${studentData.hasPaidAcceptance ? 'text-green-600' : 'text-red-500'} mt-1">
                                        ${studentData.hasPaidAcceptance ? 'PAID <i class="fas fa-check-circle"></i>' : 'UNPAID'}
                                    </p>
                                </div>
                                <div class="bg-white p-4 rounded-xl shadow-sm border ${studentData.hasPaidTuition ? 'border-green-200 bg-green-50' : 'border-gray-200'}">
                                    <p class="text-xs font-bold text-gray-400 uppercase">Tuition Fee</p>
                                    <p class="text-2xl font-bold text-gray-800">₦50,000</p>
                                    <p class="text-xs font-bold ${studentData.hasPaidTuition ? 'text-green-600' : 'text-red-500'} mt-1">
                                        ${studentData.hasPaidTuition ? 'PAID <i class="fas fa-check-circle"></i>' : 'UNPAID'}
                                    </p>
                                </div>
                            </div>
                            ${formHTML}
                        </div>`;
                });
            } else if (tab === 'announcements') { fetchAndRenderAnnouncements(); }
            else if (tab === 'assignments') { fetchAndRenderAssignments(); }
        }

        function handleDownloadLetter() {
             const admNo = studentData.admNo;
             setLoading(true, 'Generating PDF... This may take a few seconds.');
             makeApiCall({ action: 'generateLetter', admNo: admNo }).then(response => {
                setLoading(false);
                if (response.result === 'success' && response.url) {
                    window.open(response.url, '_blank');
                    showMessage('Success', 'Admission Letter opened in a new tab.');
                } else { showMessage('Error', response.message || 'Could not generate letter.', false); }
             }).catch(e => { setLoading(false); showMessage('Error', 'Network error.', false); });
        }

        async function fetchAndRenderAnnouncements() {
            const data = { action: 'getAnnouncementsByCourse', course: studentData.course, currentUser: studentData.admNo };
            const content = document.getElementById('portalContent');
            try {
                const res = await makeApiCall(data);
                if(res.result === 'success' && res.data.length > 0) {
                    let html = `<div class="max-w-2xl mx-auto space-y-6">`;
                    res.data.forEach((ann, i) => {
                       const initials = "AD";
                       const likes = ann.likes || 0;
                       const comments = ann.comments || [];
                       const likedByMe = ann.likedByMe;
                       const annId = ann.id;
                       
                       html += `<div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                                <div class="p-4 flex items-center space-x-3">
                                    <div class="w-10 h-10 rounded-full bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center text-white font-bold text-sm shadow-sm">AD</div>
                                    <div class="flex-1 min-w-0">
                                        <p class="text-sm font-bold text-gray-900 truncate">Administrator</p>
                                        <p class="text-xs text-gray-500 flex items-center">
                                            <span>${ann.date}</span><span class="mx-1">•</span><span class="bg-blue-50 text-blue-600 px-1.5 rounded text-[10px] font-medium">Admin</span>
                                        </p>
                                    </div>
                                </div>
                                <div class="px-4 pb-2">
                                    <h3 class="text-base font-bold text-gray-900 mb-2 leading-tight">${ann.title}</h3>
                                    <div class="text-sm text-gray-700 leading-relaxed whitespace-pre-wrap">${ann.content}</div>
                                </div>
                                <div class="px-4 py-2 flex items-center justify-between text-xs text-gray-500 border-b border-gray-50">
                                    <div class="flex items-center space-x-1"><i class="fas fa-heart text-red-500"></i><span>${likes}</span></div>
                                    <div>${comments.length} comments</div>
                                </div>
                                <div class="px-2 py-1 flex items-center justify-between border-t border-gray-100">
                                    <button onclick="toggleLike('${ann.id}', this)" class="flex-1 flex items-center justify-center py-2 space-x-2 rounded-lg hover:bg-gray-50 transition active:scale-95 group">
                                        <i class="${likedByMe ? 'fas text-red-500' : 'far text-gray-500'} fa-heart text-lg group-hover:scale-110 transition-transform"></i>
                                        <span class="text-sm font-medium ${likedByMe ? 'text-red-500' : 'text-gray-600'} like-count">${likes > 0 ? likes : 'Like'}</span>
                                    </button>
                                    <button onclick="document.getElementById('comments-${i}').classList.toggle('hidden')" class="flex-1 flex items-center justify-center py-2 space-x-2 rounded-lg hover:bg-gray-50 transition active:scale-95 text-gray-600">
                                        <i class="far fa-comment text-lg"></i><span class="text-sm font-medium">Comment</span>
                                    </button>
                                </div>
                                <div id="comments-${i}" class="hidden bg-gray-50 border-t border-gray-100 p-4">
                                    <div class="space-y-4 mb-4 max-h-60 overflow-y-auto custom-scrollbar" id="comment-list-${ann.id}">
                                        ${comments.map(c => `<div class="flex space-x-3"><div class="w-8 h-8 rounded-full bg-blue-100 flex-shrink-0 flex items-center justify-center text-blue-600 text-xs font-bold">${c.user.charAt(0)}</div><div class="bg-white p-3 rounded-2xl rounded-tl-none shadow-sm border border-gray-200 flex-1"><div class="flex justify-between items-baseline mb-1"><span class="text-xs font-bold text-gray-900">${c.user}</span><span class="text-[10px] text-gray-400 ml-2">${c.time}</span></div><p class="text-sm text-gray-700">${c.text}</p></div></div>`).join('')}
                                    </div>
                                    <div class="flex items-center space-x-2 bg-white p-1.5 rounded-full border border-gray-300 shadow-sm focus-within:border-blue-500 focus-within:ring-1 focus-within:ring-blue-500">
                                        <div class="w-8 h-8 rounded-full bg-gray-200 flex-shrink-0 flex items-center justify-center text-gray-600 text-xs font-bold ml-1">ME</div>
                                        <input type="text" id="input-${ann.id}" placeholder="Write a comment..." class="flex-1 bg-transparent border-none focus:ring-0 text-sm px-2 py-1">
                                        <button onclick="postComment('${ann.id}')" class="w-8 h-8 bg-blue-600 text-white rounded-full flex items-center justify-center hover:bg-blue-700 transition shadow-sm"><i class="fas fa-paper-plane text-xs"></i></button>
                                    </div>
                                </div>
                               </div>`;
                    });
                    content.innerHTML = html + `</div>`;
                } else { content.innerHTML = `<div class="card text-center text-gray-500 p-10"><i class="fas fa-newspaper text-4xl mb-4 text-gray-300"></i><p>No posts yet.</p></div>`; }
            } catch(e){ content.innerHTML = `<div class="text-center text-red-500 p-10">Failed to load feed.</div>`; }
        }

        async function fetchAndRenderAssignments() {
            const data = { action: 'getAssignmentsByCourse', course: studentData.course };
            const content = document.getElementById('portalContent');
            try {
                const res = await makeApiCall(data);
                if(res.result === 'success' && res.data.length > 0) {
                    let html = `<div class="max-w-3xl mx-auto space-y-4">`;
                    res.data.forEach(ass => {
                       html += `<div class="bg-white p-5 rounded-xl shadow-sm border flex justify-between items-center">
                                <div><h3 class="font-bold">${ass.title||ass.Title}</h3><p class="text-sm text-gray-600">${ass.description||ass.Description}</p><p class="text-xs text-red-500 mt-1">Due: ${ass.dueDate||ass.DueDate}</p></div>
                                <button class="bg-blue-50 text-blue-600 px-4 py-2 rounded-lg font-medium text-sm hover:bg-blue-100 transition whitespace-nowrap">View</button>
                               </div>`;
                    });
                    content.innerHTML = html + `</div>`;
                } else { content.innerHTML = `<div class="card text-center p-10 text-gray-500">No active assignments.</div>`; }
            } catch(e){ content.innerHTML = `<div class="text-center text-red-500 p-10">Failed to load assignments.</div>`; }
        }

        // --- SOCIAL ACTIONS (Restored full logic) ---
        async function toggleLike(annId, btnElement) {
            const icon = btnElement.querySelector('i');
            const countSpan = btnElement.querySelector('.like-count');
            let text = countSpan.innerText;
            let currentCount = (text === 'Like') ? 0 : parseInt(text);
            const isLiked = icon.classList.contains('fas') && icon.classList.contains('text-red-500');

            if (isLiked) {
                icon.classList.remove('fas', 'text-red-500'); icon.classList.add('far', 'text-gray-500');
                countSpan.classList.remove('text-red-500'); countSpan.classList.add('text-gray-600');
                const newCount = currentCount - 1;
                countSpan.innerText = newCount > 0 ? newCount : 'Like';
            } else {
                icon.classList.remove('far', 'text-gray-500'); icon.classList.add('fas', 'text-red-500');
                countSpan.classList.remove('text-gray-600'); countSpan.classList.add('text-red-500');
                countSpan.innerText = currentCount + 1;
            }
            try { await fetch(ENDPOINT_URL, { method: 'POST', mode: 'cors', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body: new URLSearchParams({ action: 'toggleLike', announcementId: annId, user: studentData.admNo }) }); } catch (e) { }
        }

        async function postComment(annId) {
            const input = document.getElementById(`input-${annId}`);
            const text = input.value.trim();
            if(!text) return;
            const list = document.getElementById(`comment-list-${annId}`);
            const temp = `<div class="flex space-x-3"><div class="w-8 h-8 rounded-full bg-blue-100 flex-shrink-0 flex items-center justify-center text-blue-600 text-xs font-bold">${studentData.firstName.charAt(0)}</div><div class="bg-white p-3 rounded-2xl rounded-tl-none shadow-sm border border-gray-200 flex-1"><div class="flex justify-between items-baseline mb-1"><span class="text-xs font-bold text-gray-900">Me</span><span class="text-[10px] text-gray-400 ml-2">Just now</span></div><p class="text-sm text-gray-700">${text}</p></div></div>`;
            list.insertAdjacentHTML('beforeend', temp);
            input.value = '';
            try { await fetch(ENDPOINT_URL, { method: 'POST', mode: 'cors', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body: new URLSearchParams({ action: 'addComment', announcementId: annId, user: `${studentData.firstName} ${studentData.lastName}`, comment: text }) }); } catch (e) { }
        }

        document.addEventListener('DOMContentLoaded', checkAuth);
    </script>
</body>
</html>
