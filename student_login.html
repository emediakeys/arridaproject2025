<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>School Portal Login (Student Only)</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configure Tailwind for custom styles and Inter font -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'primary-blue': '#104e8b',
                        'secondary-yellow': '#fdb714',
                    }
                }
            }
        }
    </script>
    <style>
        /* Optional custom styles for subtle aesthetics */
        body {
            background-color: #f3f4f6;
            font-family: 'Inter', sans-serif;
        }
        .login-card {
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 0 10px -5px rgba(0, 0, 0, 0.04);
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <!-- Login Card Container -->
    <div id="loginContainer" class="login-card w-full max-w-md bg-white rounded-xl overflow-hidden">
        
        <!-- Header -->
        <header class="bg-primary-blue p-6 text-white text-center rounded-t-xl">
            <h1 class="text-3xl font-bold">Student Portal Login</h1>
            <p class="mt-1 text-sm opacity-90">Enter your Admission Number and Password.</p>
        </header>

        <!-- Content Area -->
        <div class="p-6">

            <!-- Student Login Form -->
            <form id="studentForm" class="login-form">
                <div class="mb-4">
                    <label for="studentAdmNo" class="block text-sm font-medium text-gray-700 mb-1">Admission Number</label>
                    <input type="text" id="studentAdmNo" name="admNo" placeholder="ACHSTS0001" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-primary-blue focus:border-primary-blue transition duration-150">
                </div>
                <div class="mb-6">
                    <label for="studentPassword" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                    <input type="password" id="studentPassword" name="password" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-primary-blue focus:border-primary-blue transition duration-150">
                </div>
                <button type="submit" class="w-full flex justify-center items-center py-2 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-secondary-yellow hover:bg-yellow-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-secondary-yellow transition duration-300">
                    <span id="studentLoadingSpinner" class="hidden animate-spin h-5 w-5 mr-3 border-2 border-white border-t-transparent rounded-full"></span>
                    Login
                </button>
            </form>

            <!-- Message Box (Error/Success) -->
            <div id="messageBox" class="mt-6 p-3 rounded-lg text-sm hidden" role="alert"></div>

        </div>
    </div>

    <script>
        // CRITICAL: Replace this placeholder with your deployed Google Apps Script Web App URL (ending in /exec)
        const SCRIPT_URL = 'YOUR_WEB_APP_URL_HERE'; 

        const studentForm = document.getElementById('studentForm');
        const messageBox = document.getElementById('messageBox');
        const studentLoadingSpinner = document.getElementById('studentLoadingSpinner');

        /**
         * Utility function to display messages.
         * @param {string} type - 'success' or 'error'
         * @param {string} message - The message text
         */
        function showMessage(type, message) {
            messageBox.textContent = message;
            messageBox.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-700');
            if (type === 'error') {
                messageBox.classList.add('bg-red-100', 'text-red-700');
            } else if (type === 'success') {
                messageBox.classList.add('bg-green-100', 'text-green-700');
            }
        }
        
        /**
         * Main function to send data to the Apps Script backend.
         * @param {string} action - 'studentLogin' (fixed action)
         * @param {object} formData - Data object from the form
         * @param {HTMLElement} submitButton - The button element to control loading state
         */
        async function submitLogin(action, formData, submitButton) {
            if (SCRIPT_URL === 'YOUR_WEB_APP_URL_HERE') {
                showMessage('error', 'Configuration Error: Please replace "YOUR_WEB_APP_URL_HERE" with your deployed Apps Script URL.');
                return;
            }

            // Show loading state
            submitButton.disabled = true;
            const spinner = studentLoadingSpinner; // Only one spinner now
            spinner.classList.remove('hidden');

            const payload = { ...formData, action };
            messageBox.classList.add('hidden');

            // --- Exponential Backoff Retry Logic ---
            let responseData = null;
            const maxRetries = 3;
            const initialDelay = 1000; // 1 second

            for (let attempt = 0; attempt < maxRetries; attempt++) {
                try {
                    const response = await fetch(SCRIPT_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    responseData = await response.json();
                    break; // Success, exit the loop
                } catch (error) {
                    if (attempt < maxRetries - 1) {
                        const delay = initialDelay * Math.pow(2, attempt);
                        await new Promise(resolve => setTimeout(resolve, delay));
                    } else {
                        // Log error for debugging, show generic message to user
                        console.error("Fetch failed after multiple retries:", error);
                        showMessage('error', 'Login server connection failed. Please try again.');
                        // Ensure state is reset on final failure
                        spinner.classList.add('hidden');
                        submitButton.disabled = false;
                        return; 
                    }
                }
            }

            // Hide loading state
            spinner.classList.add('hidden');
            submitButton.disabled = false;

            // Handle response
            if (responseData && responseData.result === 'success') {
                // Simplified success handling for student login only
                console.log("Student Login Successful. Retrieved data:", responseData.data);
                showMessage('success', `Welcome ${responseData.data.firstName}! Your course is ${responseData.data.course}. (Check console for full data)`);
                // In a real application, you would store the token/session and redirect here.

            } else if (responseData) {
                // Backend returned an 'error' result
                showMessage('error', responseData.message || 'Login failed due to an unknown error.');
            }
        }

        // --- Event Listener ---

        studentForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const formElements = e.target.elements;
            const formData = {
                admNo: formElements.admNo.value,
                password: formElements.password.value
            };
            // Action is hardcoded to 'studentLogin'
            submitLogin('studentLogin', formData, e.submitter);
        });

    </script>
</body>
</html>